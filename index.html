<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voorbeeldtoets Groep 3, Oefenomgeving, fullscreen responsive</title>
<style>
:root{
  --bg:#f2f2f2; --panel:#fff; --blue:#0d6efd; --blue-dark:#0b5ed7; --line:#e6e6e6;
  --text:#000; --muted:#666; --ok:#2fb073; --wrong:#b02f2f; --amber:#c58a00;
  --pad:clamp(12px, 2.2vw, 24px);
  --radius:16px;
  --navH:76px;
}

/* Basis, echte fullscreen met mobiele address-bar fixes */
html, body{height:100%;
margin:0; padding:0}
body{
  min-height:100svh;
  font-family:Arial, Helvetica, sans-serif;
  font-size:clamp(15px, 1.1vw + .4rem, 17px);
  line-height:1.5;
  color:var(--text);
  background:var(--bg);
  display:flex;
  flex-direction:column;
  padding-top: var(--navH);
  padding-bottom: var(--navH);
}

/* Headerbalk - VASTGEZET bovenaan */
.sky{
  height:clamp(56px, 8svh, 80px);
  background:var(--blue);
  border-bottom:2px solid var(--line);
  flex:0 0 auto;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

/* Hoofdpodium vult het resterende scherm */
.stage{
  flex:1 1 auto;
  min-height:0;
  display:flex;
  padding:clamp(8px, 1.5vw, 16px);
}

/* De “card” wordt het canvas dat het scherm vult */
.card{
  background:var(--panel);
  width:100%;
  height:calc(100% - 0px);
  min-height:0;
  border-radius:0;
  box-shadow:none;
  padding:calc(var(--pad) + 4px) calc(var(--pad) + 6px) var(--pad);
  position:relative;
  overflow:hidden;
  display: flex;
  flex-direction: column;
}

/* Op grotere schermen net wat zachter */
@media (min-width:900px){
  .card{
    max-width:1200px;
    margin:0 auto;
    border-radius:var(--radius);
    box-shadow:0 1px 12px rgba(0,0,0,.08);
    padding-bottom:var(--pad);
  }
}

/* Typografie */
h1{font-size:clamp(18px, 1.2vw + .8rem, 24px); font-weight:bold; margin:0 0 12px}
p{margin:0 0 10px}
.q{
  font-size:clamp(17px, 1.1vw + .6rem, 20px); font-weight:bold;
  margin:14px 0 8px;
  text-align: center;
}

/* Inputs en keuzes, grotere touch-targets */
.input{
  font-size:clamp(16px, 1vw + .6rem, 18px);
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #bbb;
  width:min(320px, 100%);
  flex-shrink: 0;
}
.choices{margin-top:8px}
.choice{display:block; margin-bottom:8px}
.choice input{width:20px; height:20px}

/* Feedbackkleuren */
.feedback{margin-top:8px; font-weight:bold; text-align: center; flex-shrink: 0;}
.ok{color:var(--ok)}
.wrong{color:var(--wrong)}

/* Verberg voortgang rechtsboven */
.progress{display:none}

/* TTS knoppen */
.ttsRow{display:inline-flex; align-items:center; gap:10px; margin-left:8px}
.ttsImgBtn{border:0; background:transparent; padding:0; margin-left:8px; cursor:pointer; display:inline-flex; align-items:center}
.ttsImgBtn img{width:40px; height:40px; display:block}
.audioBtn{
  border:0; background:#eee;
  width:48px; height:48px; border-radius:24px;
  cursor:pointer; display:inline-flex;
  align-items:center; justify-content:center
}
.audioBtn svg{width:22px; height:22px; fill:var(--blue)}
.audioBtn img{width:22px; height:22px; display:block; object-fit:contain}

/* Sections */
.task{
  display:none; 
  text-align: center;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  display:none !important;
}
.task.active{
  display:flex !important;
  overflow: hidden;
}

/* Scènepaneel */
.inner-panel{
  background:#fff;
  border-radius:clamp(10px, 1vw, 16px);
  box-shadow:inset 0 0 0 1px #eee;
  width:100%;
  max-width:1100px;
  margin:10px auto 0;
  aspect-ratio:16 / 9;
  position:relative;
  overflow:hidden;
  flex-shrink: 0;
}
.scene-play, .scene-pause{
  position:absolute;
  left:50%; top:clamp(20px, 5vh, 36px);
  transform:translateX(-50%);
  width:clamp(48px, 6.5vw, 64px); height:clamp(48px, 6.5vw, 64px);
  border:0; background:transparent; padding:0; cursor:pointer
}
.scene-play img, .scene-pause img{width:100%; height:100%; display:block}
.scene-pause.hidden, .scene-play.hidden{display:none}

/* Afbeeldingen in scène */
.scene-boy{
  position:absolute; left:50%; top:45%;
  transform:translate(-50%, -50%);
  height:min(48%, 42vh);
  width:auto; max-width:48%;
}
.scene-girl{
  position:absolute; right:clamp(12px, 2vw, 24px); bottom:clamp(10px, 2vh, 22px);
  height:min(52%, 46vh); width:auto; max-width:50%;
}

.hidden{display:none}
.hide-ui .progress{display:none}

/* Buttons algemeen */
.btn{border:1px solid #d0d0d0; background:#fff; border-radius:10px; padding:12px 16px; font-weight:bold; cursor:pointer}
.btn:hover{background:#f4f6ff}
.btn[disabled]{opacity:.5; cursor:not-allowed}

/* Eindscherm */
.review{display:none}
.review.show{display:block}
.circles{
  display:flex; flex-wrap:wrap; gap:10px; margin:14px 0;
  justify-content: center;
  flex-shrink: 0;
}
.circleBtn{
  width:48px; height:48px; border-radius:24px;
  border:1px solid #d7d7d7; background:#eee;
  display:inline-flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; line-height:1
}
.circleBtn.done{background:#fff}
.endTitle{font-weight:bold; margin-top:6px}

/* Onderbalk (Footer) */
.bottomNav{
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 999;
  display:flex;
  align-items:center; justify-content:space-between; gap:10px;
  background:#fafafa; border:1px solid #ececec; border-radius:0;
  border-top: 1px solid #ececec;
  border-bottom: none; border-left: none; border-right: none;
  padding:10px 12px; min-height:var(--navH);
}
.navBtn{
  border:0; background:var(--blue); color:#fff; border-radius:12px;
  padding:12px 18px; font-weight:bold; cursor:pointer;
  flex:0 0 auto
}
.navBtn[disabled]{background:#e0e0e0; color:#666; border:1px solid #d0d0d0; cursor:not-allowed; opacity:1}

/* Pager */
.pager{
  display:flex;
  align-items:center; gap:8px; justify-content:center;
  flex:1 1 auto; flex-wrap:wrap; overflow:auto; padding:6px 4px;
  scrollbar-width:thin;
}
.pageBtn{
  width:46px; height:46px; border-radius:23px; border:1px solid #d7d7d7; background:#eee;
  display:inline-flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; padding:0; line-height:1;
  flex:0 0 auto;
}
.pageBtn.current{
  width:56px; height:56px; border-radius:28px; font-size:18px; background:var(--blue); color:#fff;
  border-color:var(--blue)
}
.pageBtn.answered:not(.current){background:#fff}

/* In eindscherm geen onderbalk tonen */
.end-view .bottomNav{display:none}
.end-view body{padding-bottom: 0;}

/* Respecteer reduced motion */
@media (prefers-reduced-motion:reduce){
  *{scroll-behavior:auto}
}

/* Centreren van taakafbeeldingen */
.task img{
  display: block;
  max-width: 100%;
  height: auto;
  margin: 10px auto 16px;
  border-radius: var(--radius);
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}

/* Wrapper voor afbeelding, invoer en toetsenbord */
.task-content-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px; 
  flex-grow: 1;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 10px;
  min-height: 0;
}

@media (min-width: 768px) {
  .task-content-wrapper.with-keyboard {
    flex-direction: row;
    justify-content: center;
    align-items: flex-start;
  }
}

.image-container {
  display: flex;
  flex-direction: column;
  justify-content: center; 
  align-items: center;
  max-width: 100%;
  max-height: 100%;
  min-height: 0;
  flex-shrink: 1;
}
.image-container img {
  max-height: 100%;
  width: auto;
  object-fit: contain;
  margin: 0;
}

.input-keyboard-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  flex-shrink: 0; 
}

/* Virtueel toetsenbord */
.keyboard {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px; 
  width: 100%;
  max-width: 320px;
  margin-top: 15px;
  padding: 10px;
  background: var(--bg);
  border-radius: var(--radius);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.key-btn {
  background-color: var(--panel);
  color: var(--text);
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 0;
  font-size: clamp(28px, 4.5vw, 42px);
  font-weight: bold;
  aspect-ratio: 1 / 1;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.key-btn:hover { background-color: #f0f0f0; border-color: var(--blue); }
.key-btn:active { box-shadow: none; transform: translateY(1px); }
.key-btn.zero { grid-column: 1 / span 2; aspect-ratio: auto; height: 100%; }
.key-btn.backspace {
  background-color: var(--wrong);
  color: white;
  border: 1px solid var(--wrong);
  font-size: 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.key-btn.backspace:hover { background-color: var(--wrong); opacity: 0.9; }
.backspace-icon { width: 60%; height: 60%; fill: white; }

.input-with-label { display: flex; flex-direction: column; align-items: center; gap: 5px; flex-shrink: 0; }
.input-keyboard-container { display: flex; flex-direction: column; align-items: center; }
.input-keyboard-container > .input-with-label { order: 2; }
.input-keyboard-container > .keyboard { order: 1; margin-top: 0; }

/* Keuzeknoppen opgave 3 */
.choices-container{ margin: 15px 0; width: 100%; max-width: 500px; flex-shrink: 0; }
.choices-row{ display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
.choice-btn{ flex: 1 1 auto; min-width: 100px; padding: 15px 10px; font-size: 1.1em; font-weight: bold; }
.choice-btn.selected{ background: var(--blue); color: #fff; border-color: var(--blue-dark); }
</style>
</head>
<body>
<div class="sky"></div>
<div class="stage">
<main class="card">

<section class="task active" data-kind="intro" data-tts="Controle van geluid. Druk op de knop met de driehoek. Als het geluid werkt, vink het vakje aan.">
  <h1>Controle van het geluid</h1>
  <p>
    <button id="audioPlay" class="audioBtn" aria-label="Speel geluid">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
    </button>
  </p>
  <p class="q">
    <label><input type="checkbox" class="check" id="soundOk"> Het geluid werkt</label>
  </p>
  <p class="q">Werkt het niet, meld dit aan je docent.</p>
  <!-- NIEUW: Start knop die het woord 'start' uitspreekt -->
  <p class="q">
    <button id="startBtn" class="btn" aria-label="Start">Start</button>
  </p>
</section>

<section class="task" data-kind="scene" data-tts="Uitlegscreen">
  <h1>Luisteren naar de uitleg</h1>
  <div class="inner-panel" aria-label="Uitlegscherm">
    <img src="jongetje.jpg" alt="Jongen" class="scene-boy">
    <img src="meisje.jpg" alt="Meisje" class="scene-girl">
    <button id="scenePlay" class="scene-play" aria-label="Afspelen" title="Afspelen">
      <img src="speel.jpg" alt="Afspelen">
    </button>
    <button id="scenePause" class="scene-pause hidden" aria-label="Pauzeer" title="Pauzeer">
      <img src="pauze.jpg" alt="Pauze">
    </button>
  </div>
</section>

<section class="task" data-kind="task" data-answer="13" data-tts="Opgave 1, Sophie heeft een briefje van tien euro, twee muntjes van twee euro en een muntje van één euro. Hoeveel euro heeft Sophie in totaal?">
  <h1>Opgave 1</h1>
  <p class="q">Sophie heeft 1 briefje van &euro;10,<br> 2 muntjes van &euro;2 en 1 muntje van &euro;1.<br> Hoeveel euro heeft Sophie in totaal?
    <button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
  </p>
  <div class="task-content-wrapper with-keyboard">
    <div class="image-container">
      <img src="01 geld.jpg" alt="Briefje van 10 euro, twee munten van 2 euro en één munt van 1 euro.">
    </div>
    <div class="input-keyboard-container">
      <div class="keyboard" data-target-input=".input"></div>
      <div class="input-with-label">
        <input class="input" type="text" inputmode="text" placeholder="Antwoordvak" data-numeric-only="true" />
      </div>
    </div>
  </div>
  <div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="13" data-tts="Opgave 2, Tom heeft drie rode blokken, zes groene en vier blauwe blokken. Hij stapelt alle blokken. Hoeveel blokken hoog wordt zijn toren?">
  <h1>Opgave 2</h1>
  <p class="q">Tom heeft 3 rode blokken, 6 groene en 4 blauwe blokken.<br> Hij stapelt alle blokken. Hoeveel blokken hoog wordt zijn toren?
    <button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
  </p>
  <div class="task-content-wrapper with-keyboard">
    <div class="image-container">
      <img src="02 tom blokkentoren.jpg" alt="Blokken in drie kleuren die opgestapeld worden.">
    </div>
    <div class="input-keyboard-container">
      <div class="keyboard" data-target-input=".input"></div>
      <div class="input-with-label">
        <input class="input" type="text" inputmode="text" placeholder="Antwoordvak" data-numeric-only="true" />
      </div>
    </div>
  </div>
  <div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="5 uur" data-tts="Opgave 3, Het is nu drie uur. Over twee uur moet Lisa naar muziekles. Hoe laat is het dan?">
  <h1>Opgave 3</h1>
  <p class="q">Het is nu 3 uur. Over twee uur moet Lisa naar muziekles.<br> Hoe laat is het dan?
    <button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
  </p>
  <div class="task-content-wrapper">
    <div class="image-container">
      <img src="03 muziekles.jpg" alt="Illustratie van een klok of tijd.">
    </div>
    <div class="choices-container">
      <div class="choices-row">
        <button class="choice-btn btn" data-value="2 uur">2 uur</button>
        <button class="choice-btn btn" data-value="3 uur">3 uur</button>
        <button class="choice-btn btn" data-value="4 uur">4 uur</button>
        <button class="choice-btn btn" data-value="5 uur">5 uur</button>
      </div>
    </div>
  </div>
  <div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="6" data-tts="Opgave 4, Jasper gooit een vier met de eerste dobbelsteen. Welke score moet hij met de tweede dobbelsteen gooien om samen tien te behalen?">
  <h1>Opgave 4</h1>
  <p class="q">Jasper gooit een 4 met de eerste dobbelsteen.<br> Welke score moet hij met de tweede dobbelsteen gooien om samen 10 te behalen?
    <button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
  </p>
  <div class="task-content-wrapper with-keyboard">
    <div class="image-container">
      <img src="04 dobbelen.jpg" alt="Een dobbelsteen met vier ogen.">
    </div>
    <div class="input-keyboard-container">
      <div class="keyboard" data-target-input=".input"></div>
      <div class="input-with-label">
        <input class="input" type="text" inputmode="text" placeholder="Antwoordvak" data-numeric-only="true" />
      </div>
    </div>
  </div>
  <div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="3" data-tts="Opgave 5, Tom en Lisa tellen hun snoepjes. Tom heeft zes snoepjes, Lisa negen snoepjes. Hoeveel snoepjes heeft Lisa meer?">
  <h1>Opgave 5</h1>
  <p class="q">Tom en Lisa tellen hun snoepjes. Tom heeft 6 snoepjes, Lisa 9 snoepjes.<br> Hoeveel snoepjes heeft Lisa meer?
    <button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
  </p>
  <div class="task-content-wrapper with-keyboard">
    <div class="image-container">
      <img src="05 snoepjes.jpg" alt="Een groepje van zes snoepjes en een groepje van negen snoepjes.">
    </div>
    <div class="input-keyboard-container">
      <div class="keyboard" data-target-input=".input"></div>
      <div class="input-with-label">
        <input class="input" type="text" inputmode="text" placeholder="Antwoordvak" data-numeric-only="true" />
      </div>
    </div>
  </div>
  <div class="feedback"></div>
</section>

<section class="task review" data-kind="end" data-tts="Klaar, je bent nu bij het eindscherm, controleer of je alle opgaven hebt gemaakt">
  <h1>Klaar</h1>
  <p class="endTitle">Je bent nu bij het eindscherm.
  Controleer of je alle opdrachten hebt gemaakt.</p>
  <div id="endCircles" class="circles" aria-label="Overzicht opgaven"></div>
</section>

<div class="bottomNav" aria-label="Navigatie onder">
  <button id="prevBtn" class="navBtn" aria-label="Vorige">Vorige</button>
  <div id="pager" class="pager" aria-label="Opgaven"></div>
  <button id="nextBtn" class="navBtn" aria-label="Volgende">Volgende</button>
</div>
</main>
</div>

<script>
(function(){
const tasks=[...document.querySelectorAll('.task')];
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const pager=document.getElementById('pager');

// indices
const taskIndexes = tasks.map((t,ix)=>({ix, kind:t.dataset.kind}));
const itemIx = taskIndexes.filter(x=>x.kind==='task').map(x=>x.ix);
const firstTask = itemIx[0];
const introIx = tasks.findIndex(t=>t.dataset.kind==='intro');
const sceneIx = tasks.findIndex(t=>t.dataset.kind==='scene');
const endIx = tasks.findIndex(t=>t.dataset.kind==='end');
// administratie
let i=0, score=0;
const state = itemIx.reduce((acc,ix)=>{ acc[ix] = { answered:false, correct:null, value:null }; return acc; },{});

// TTS basis
const synth = window.speechSynthesis;
let voices = [], chosenVoiceIndex = 0;
function loadVoices(){ 
  voices = synth ? synth.getVoices() : [];
  if(voices.length > 0){
    let voiceIndex = -1;
    voiceIndex = voices.findIndex(v => v.lang && v.lang.startsWith('nl') && (v.name.includes('Female') || v.name.includes('Vrouw') || v.name.includes('Google Nederlands') || v.name.includes('Google NL-NL')));
    if (voiceIndex === -1) {
      voiceIndex = voices.findIndex(v => v.lang && v.lang.startsWith('nl'));
    }
    chosenVoiceIndex = voiceIndex >= 0 ? voiceIndex : 0;
  }
}
if(synth){
  loadVoices();
  synth.onvoiceschanged = loadVoices;
}
function hardResetTTS(){
  try{
    if(!synth) return;
    synth.cancel();
    if(synth.paused){ synth.resume(); }
    const u=new SpeechSynthesisUtterance(''); u.volume=0; synth.speak(u); synth.cancel();
  }catch(e){}
}
function stopAllTTS(){
  try{ if(synth){ hardResetTTS(); } }catch(e){}
  document.querySelectorAll('.ttsImgBtn').forEach(btn=>{
    const img = btn.querySelector('img'); if(img) img.src='speel.jpg'; btn.dataset.playing='false';
  });
  showPlayIcon();
}
function speakOnce(text, opts={onstart:null,onend:null,pauseable:true,section:null}){
  if(!synth || !text) return;
  try{ hardResetTTS(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  const v = voices[chosenVoiceIndex];
  if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'nl-NL'; }
  u.rate = ('rate' in opts)? opts.rate : 0.95;
  u.pitch = ('pitch' in opts)? opts.pitch : 1.0;
  if(typeof opts.onstart==='function') u.onstart = opts.onstart;
  if(typeof opts.onend==='function') u.onend = opts.onend;
  synth.speak(u);
}

// Scene logica
const scenePlay = document.getElementById('scenePlay');
const scenePause = document.getElementById('scenePause');
let scenePlaying = false;
function showPauseIcon(){ if(scenePlay) scenePlay.classList.add('hidden'); if(scenePause) scenePause.classList.remove('hidden'); }
function showPlayIcon(){ if(scenePause) scenePause.classList.add('hidden'); if(scenePlay) scenePlay.classList.remove('hidden'); }
function enterSceneIntro(){ showPlayIcon(); const line1 = 'Als je de uitleg wil horen, klik je op de driehoek.'; speakOnce(line1,{onend:()=>{ showPlayIcon(); }}); }
function handleScenePlay(){
  if(scenePlaying){
    try{ synth.pause(); }catch(e){}
    scenePlaying=false; showPlayIcon(); return;
  }
  scenePlaying=true; showPauseIcon();
  const main = 'Klik rechtsonder op de knop';
  const emphas = 'volgende';
  speakOnce(main,{onend:()=>{
    speakOnce(emphas,{rate:0.9,pitch:1.6,onend:()=>{
      scenePlaying=false; showPlayIcon(); setNextEnabled(true);
    }});
  }});
  setNextEnabled(false);
}
function pauseScene(){ try{ synth.pause(); }catch(e){} scenePlaying=false; showPlayIcon(); }
if(scenePlay){ scenePlay.addEventListener('click', handleScenePlay); }
if(scenePause){ scenePause.addEventListener('click', pauseScene); }

function setNextEnabled(on){ nextBtn.disabled = !on; }
  
function check(ix){
  const t=tasks[ix];
  if(!t||t.dataset.kind!=='task') return true;
  const ans=t.dataset.answer;
  const input=t.querySelector('input.input');
  const selectedBtn=t.querySelector('.choice-btn.selected'); 
  const fb=t.querySelector('div.feedback');
  let ok=false, value=null;
  if(input){
    value=input.value.trim();
    ok = String(ans) === value;
  } else if (selectedBtn) {
    value = selectedBtn.dataset.value;
    ok = String(ans) === value;
  } else {
    value = null;
  }
  fb.textContent='';
  fb.className='feedback';
  if(value!==null && value!==''){
    state[ix].answered=true; 
    state[ix].correct=ok; 
    state[ix].value=value;
    if(ok && !t.dataset.counted){ score++; t.dataset.counted='1'; }
    if(!ok && t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
  } else {
    state[ix].answered=false; 
    state[ix].correct=null;
    if(t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
  }
  renderPager();
  return state[ix].answered ? ok : false;
}

// Inject TTS image buttons voor tasks
function ensureTaskTTSControls(section){
  if(section.dataset.kind!=='task') return;
  if(!section.dataset.tts) return;
  const btn = section.querySelector('.ttsImgBtn');
  if(!btn) return;
  const img = btn.querySelector('img'); if(!img) return;
  btn.dataset.playing='false';
  function onStart(){ btn.dataset.playing='true'; img.src='pauze.jpg'; }
  function onEnd(){ btn.dataset.playing='false'; img.src='speel.jpg'; }
  if(!btn._bound){
    btn.addEventListener('click', ()=>{
      const playing = btn.dataset.playing==='true';
      if(playing){ try{ synth.pause(); }catch(e){} btn.dataset.playing='false'; img.src='speel.jpg'; return; }
      onStart();
      const tts = section.dataset.tts || section.querySelector('.q')?.textContent || '';
      speakOnce(tts,{onend:()=>{ onEnd(); }});
    });
    btn._bound = true;
  }
}

function show(k){
  tasks.forEach((t,ix)=>t.classList.toggle('active', ix===k));
  const active = tasks[k];
  const kind = active?.dataset.kind;
  if (kind === 'intro') { prevBtn.style.visibility = 'hidden'; } else { prevBtn.style.visibility = 'visible'; }

  const endSection = tasks.find(t=>t.dataset.kind==='end');
  if(endSection){
    if(kind==='end'){ endSection.classList.add('show'); document.body.classList.add('end-view'); }
    else { endSection.classList.remove('show'); document.body.classList.remove('end-view'); }
  }
  if(kind==='scene'){ document.body.classList.add('hide-ui'); } else { document.body.classList.remove('hide-ui'); }

  stopAllTTS();
  showPlayIcon();
  if(kind!=='intro'){ stopSoundLoop(); }

  if(kind==='task'){
    ensureTaskTTSControls(active);
    const firstInput = active.querySelector('input.input'); 
    if(firstInput){ 
      setTimeout(()=>{
        firstInput.focus();
        if (document.activeElement !== firstInput) {
          firstInput.focus();
        }
      }, 50);
    }
    prevBtn.disabled = (itemIx.indexOf(k)===0);
    setNextEnabled(true);
    renderPager();
  }else if(kind==='intro'){
    const introText = active.dataset.tts || 'Controle van geluid. Druk op de knop met de driehoek. Als het geluid werkt, vink het vakje aan.';
    speakOnce(introText);
    setNextEnabled(!!document.getElementById('soundOk')?.checked);
    renderPager(true);
  }else if(kind==='scene'){
    setNextEnabled(false);
    renderPager(true);
    enterSceneIntro();
  }else if(kind==='end'){
    fillEndCircles();
    setNextEnabled(false);
    renderPager(true);
  }
}

// Paginering
function renderPager(hideAll){
  pager.innerHTML='';
  if(hideAll){ return; }
  const total = itemIx.length; if(total===0) return;
  const currentIdx = itemIx.indexOf(i);
  for(let k=0;k<total;k++){
    const ixTask = itemIx[k];
    const b=document.createElement('button');
    const isCurrent = (currentIdx===k);
    b.className='pageBtn'+(isCurrent?' current':'')+(state[ixTask]?.answered && !isCurrent ? ' answered':'');
    b.type='button'; b.textContent=String(k+1);
    if(!isCurrent){ b.addEventListener('click', ()=>{ i=itemIx[k]; show(i); }); }
    pager.appendChild(b);
  }
}

// Eindscherm
function fillEndCircles(){
  const wrap=document.getElementById('endCircles');
  wrap.innerHTML='';
  itemIx.forEach((ix,idx)=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='circleBtn'+(state[ix].answered ? ' done' : '');
    btn.textContent=String(idx+1);
    btn.addEventListener('click', ()=>{ i=ix; show(i); });
    wrap.appendChild(btn);
  });
}

// Keuzeknoppen instellen (Opgave 3)
function setupChoiceButtons() {
  document.querySelectorAll('.choice-btn').forEach(btn => {
    if (btn._bound) return;
    btn.addEventListener('click', (e) => {
      const task = e.target.closest('.task');
      if (!task) return;
      task.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
      e.target.classList.add('selected');
      check(tasks.indexOf(task));
    });
    btn._bound = true;
  });
}

// Virtueel Toetsenbord
const keyboardLayout = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0, 'del'];
const keyboards = document.querySelectorAll('.keyboard');

function renderKeyboards() {
  keyboards.forEach(kb => {
    kb.innerHTML = '';
    const targetSelector = kb.dataset.targetInput;
    if (!targetSelector) return;
    const targetInput = kb.closest('.task').querySelector(targetSelector);
    if (!targetInput) return;

    keyboardLayout.forEach(key => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.classList.add('key-btn');
      if (key === 'del') {
        btn.classList.add('backspace');
