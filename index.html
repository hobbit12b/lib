

<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voorbeeldtoets Groep 3, Oefenomgeving, fullscreen responsive</title>
<style>
:root{
  --bg:#f2f2f2; --panel:#fff; --blue:#0d6efd; --blue-dark:#0b5ed7; --line:#e6e6e6; --text:#000; --muted:#666; --ok:#2fb073; --wrong:#b02f2f; --amber:#c58a00;
  --pad:clamp(12px, 2.2vw, 24px);
  --radius:16px;
  --navH:76px;
}

/* Basis, echte fullscreen met mobiele address-bar fixes */
html, body{height:100%; margin:0; padding:0}
body{
  min-height:100svh;
  font-family:Arial, Helvetica, sans-serif;
  font-size:clamp(15px, 1.1vw + .4rem, 17px);
  line-height:1.5;
  color:var(--text);
  background:var(--bg);
  display:flex;
  flex-direction:column;
}

/* Headerbalk */
.sky{
  height:clamp(56px, 8svh, 80px);
  background:var(--blue);
  border-bottom:2px solid var(--line);
  flex:0 0 auto;
}

/* Hoofdpodium vult het resterende scherm */
.stage{
  flex:1 1 auto;
  min-height:0;
  display:flex;
  padding:clamp(8px, 1.5vw, 16px);
}

/* De “card” wordt het canvas dat het scherm vult */
.card{
  background:var(--panel);
  width:100%;
  height:calc(100% - 0px);
  min-height:0;
  border-radius:0;
  box-shadow:none;
  padding:calc(var(--pad) + 4px) calc(var(--pad) + 6px) calc(var(--pad) + var(--navH) + 16px);
  position:relative;
  overflow:auto;
}

/* Op grotere schermen net wat zachter */
@media (min-width:900px){
  .card{
    max-width:1200px;
    margin:0 auto;
    border-radius:var(--radius);
    box-shadow:0 1px 12px rgba(0,0,0,.08);
    padding-bottom:calc(var(--pad) + var(--navH) + 20px);
  }
}

/* Typografie */
h1{font-size:clamp(18px, 1.2vw + .8rem, 24px); font-weight:bold; margin:0 0 12px}
p{margin:0 0 10px}
.q{font-size:clamp(17px, 1.1vw + .6rem, 20px); font-weight:bold; margin:14px 0 8px}

/* Inputs en keuzes, grotere touch-targets */
.input{
  font-size:clamp(16px, 1vw + .6rem, 18px);
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #bbb;
  width:min(320px, 100%);
}
.choices{margin-top:8px}
.choice{display:block; margin-bottom:8px}
.choice input{width:20px; height:20px}

/* Feedbackkleuren */
.feedback{margin-top:8px; font-weight:bold}
.ok{color:var(--ok)}
.wrong{color:var(--wrong)}

/* Verberg voortgang rechtsboven, zoals gewenst */
.progress{display:none}

/* TTS knoppen compact, maar vinger-vriendelijk */
.ttsRow{display:inline-flex; align-items:center; gap:10px; margin-left:8px}
.ttsImgBtn{border:0; background:transparent; padding:0; margin-left:8px; cursor:pointer; display:inline-flex; align-items:center}
.ttsImgBtn img{width:40px; height:40px; display:block}
.audioBtn{
  border:0; background:#eee;
  width:48px; height:48px; border-radius:24px;
  cursor:pointer; display:inline-flex; align-items:center; justify-content:center
}
.audioBtn svg{width:22px; height:22px; fill:var(--blue)}
.audioBtn img{width:22px; height:22px; display:block; object-fit:contain}

/* Sections */
.task{display:none}
.task.active{display:block}

/* Scènepaneel is responsive met aspect-ratio */
.inner-panel{
  background:#fff;
  border-radius:clamp(10px, 1vw, 16px);
  box-shadow:inset 0 0 0 1px #eee;
  width:100%;
  max-width:1100px;
  margin:10px auto 0;
  aspect-ratio:16 / 9;
  position:relative;
  overflow:hidden;
}
.scene-play, .scene-pause{
  position:absolute; left:50%; top:clamp(20px, 5vh, 36px);
  transform:translateX(-50%);
  width:clamp(48px, 6.5vw, 64px); height:clamp(48px, 6.5vw, 64px);
  border:0; background:transparent; padding:0; cursor:pointer
}
.scene-play img, .scene-pause img{width:100%; height:100%; display:block}
.scene-pause.hidden, .scene-play.hidden{display:none}

/* Afbeeldingen binnen de scène schalen proportioneel en blijven zichtbaar */
.scene-boy{
  position:absolute; left:50%; top:45%;
  transform:translate(-50%, -50%);
  height:min(48%, 42vh); width:auto; max-width:48%;
}
.scene-girl{
  position:absolute; right:clamp(12px, 2vw, 24px); bottom:clamp(10px, 2vh, 22px);
  height:min(52%, 46vh); width:auto; max-width:50%;
}

.hidden{display:none}
.hide-ui .progress{display:none}

/* Buttons algemeen */
.btn{border:1px solid #d0d0d0; background:#fff; border-radius:10px; padding:12px 16px; font-weight:bold; cursor:pointer}
.btn:hover{background:#f4f6ff}
.btn[disabled]{opacity:.5; cursor:not-allowed}

/* Eindscherm, overzicht met tikbare rondjes */
.review{display:none}
.review.show{display:block}
.circles{display:flex; flex-wrap:wrap; gap:10px; margin:14px 0}
.circleBtn{
  width:48px; height:48px; border-radius:24px; border:1px solid #d7d7d7; background:#eee;
  display:inline-flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; line-height:1
}
.circleBtn.done{background:#fff}
.endTitle{font-weight:bold; margin-top:6px}

/* Onderbalk blijft bruikbaar en past zich aan */
.bottomNav{
  position:sticky; bottom:0;
  left:0; right:0;
  margin-top:20px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  background:#fafafa; border:1px solid #ececec; border-radius:12px;
  padding:10px 12px; min-height:var(--navH);
}
.navBtn{
  border:0; background:var(--blue); color:#fff; border-radius:12px;
  padding:12px 18px; font-weight:bold; cursor:pointer; flex:0 0 auto
}
.navBtn[disabled]{background:#e0e0e0; color:#666; border:1px solid #d0d0d0; cursor:not-allowed; opacity:1}

/* Pager kan scrollen en wrappen op klein scherm */
.pager{
  display:flex; align-items:center; gap:8px; justify-content:center;
  flex:1 1 auto; flex-wrap:wrap; overflow:auto; padding:6px 4px;
  scrollbar-width:thin;
}
.pageBtn{
  width:46px; height:46px; border-radius:23px; border:1px solid #d7d7d7; background:#eee;
  display:inline-flex; align-items:center; justify-content:center; font-weight:bold; cursor:pointer; padding:0; line-height:1;
  flex:0 0 auto;
}
.pageBtn.current{
  width:56px; height:56px; border-radius:28px; font-size:18px; background:var(--blue); color:#fff; border-color:var(--blue)
}
/* Reeds beantwoord, wit, huidige, blauw */
.pageBtn.answered:not(.current){background:#fff}

/* In eindscherm geen onderbalk tonen, zoals bij je vorige versie */
.end-view .bottomNav{display:none}

/* Respecteer reduced motion voorkeuren */
@media (prefers-reduced-motion:reduce){
  *{scroll-behavior:auto}
}
</style>
</head>
<body>
<div class="sky"></div>
<div class="stage">
<main class="card">

<!-- 1. Intro -->
<section class="task active" data-kind="intro" data-tts="Controle van geluid. Druk op de knop met de driehoek. Als het geluid werkt druk je op het vierkantje.">
<h1>Controle van het geluid</h1>
<p><button id="audioPlay" class="audioBtn" aria-label="Speel geluid">
<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
</button></p>
<p class="q"><label><input type="checkbox" class="check" id="soundOk"> Het geluid werkt</label></p>
<p class="q">Werkt het niet, meld dit aan je docent.</p>
</section>

<!-- 2. Uitlegscene -->
<section class="task" data-kind="scene" data-tts="Uitlegscreen">
<h1>Luisteren naar de uitleg</h1>
<div class="inner-panel" aria-label="Uitlegscherm">
<img src="jongetje.jpg" alt="Jongen" class="scene-boy">
<img src="meisje.jpg" alt="Meisje" class="scene-girl">
<button id="scenePlay" class="scene-play" aria-label="Afspelen" title="Afspelen">
<img src="speel.jpg" alt="Afspelen">
</button>
<button id="scenePause" class="scene-pause hidden" aria-label="Pauzeer" title="Pauzeer">
<img src="pauze.jpg" alt="Pauze">
</button>
</div>
</section>

<!-- 3. Opgaven -->
<section class="task" data-kind="task" data-answer="7" data-tts="Opgave 1, splits dertien in twee delen, het eerste deel is zes, wat is het tweede deel">
<h1>Opgave 1</h1>
<p class="q">Splits 13 in twee delen. Het eerste deel is 6. Wat is het tweede deel
<button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
</p>
<input class="input" inputmode="numeric" />
<div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="11" data-tts="Opgave 2, reken uit, zeven plus zes min twee is hoeveel">
<h1>Opgave 2</h1>
<p class="q">Reken uit, 7 plus 6, 2 eraf is hoeveel
<button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
</p>
<input class="input" inputmode="numeric" />
<div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="half 4" data-tts="Opgave 3, de grote wijzer staat op zes, de kleine wijzer staat tussen drie en vier, hoe laat is het">
<h1>Opgave 3</h1>
<p class="q">De grote wijzer staat op 6, de kleine wijzer staat tussen 3 en 4. Hoe laat is het
<button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
</p>
<input class="input" />
<div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="b" data-tts="Opgave 4, lees, de poes slaapt op de mat, waar ligt de poes">
<h1>Opgave 4</h1>
<p class="q">Lees, De poes slaapt op de <strong>mat</strong>. Waar ligt de poes
<button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
</p>
<div class="choices">
<label class="choice"><input type="radio" name="q4" value="a"> op de kast</label>
<label class="choice"><input type="radio" name="q4" value="b"> op de mat</label>
<label class="choice"><input type="radio" name="q4" value="c"> in de doos</label>
</div>
<div class="feedback"></div>
</section>

<section class="task" data-kind="task" data-answer="85" data-tts="Opgave 5, een appel kost vijfendertig cent, een banaan kost vijftig cent, hoeveel cent samen">
<h1>Opgave 5</h1>
<p class="q">Een appel kost 35 cent, een banaan kost 50 cent. Hoeveel cent samen
<button class="ttsImgBtn" aria-label="Speel opgave" title="Speel opgave"><img src="speel.jpg" alt="Speel"></button>
</p>
<input class="input" inputmode="numeric" />
<div class="feedback"></div>
</section>

<!-- 4. Eindscherm -->
<section class="task review" data-kind="end" data-tts="Klaar, je bent nu bij het eindscherm, controleer of je alle opgaven hebt gemaakt">
<h1>Klaar</h1>
<p class="endTitle">Je bent nu bij het eindscherm. Controleer of je alle opdrachten hebt gemaakt.</p>
<div id="endCircles" class="circles" aria-label="Overzicht opgaven"></div>
</section>

<!-- Onderbalk -->
<div class="bottomNav" aria-label="Navigatie onder">
<button id="prevBtn" class="navBtn" aria-label="Vorige">Vorige</button>
<div id="pager" class="pager" aria-label="Opgaven"></div>
<button id="nextBtn" class="navBtn" aria-label="Volgende">Volgende</button>
</div>
</main>
</div>

<script>
(function(){
const tasks=[...document.querySelectorAll('.task')];
const prevBtn=document.getElementById('prevBtn');
const nextBtn=document.getElementById('nextBtn');
const pager=document.getElementById('pager');

// indices
const taskIndexes = tasks.map((t,ix)=>({ix, kind:t.dataset.kind}));
const itemIx = taskIndexes.filter(x=>x.kind==='task').map(x=>x.ix);
const firstTask = itemIx[0];
const introIx = tasks.findIndex(t=>t.dataset.kind==='intro');
const sceneIx = tasks.findIndex(t=>t.dataset.kind==='scene');

// administratie
let i=0, score=0;
const state = itemIx.reduce((acc,ix)=>{ acc[ix] = { answered:false, correct:null, value:null }; return acc; },{});

// TTS basis
const synth = window.speechSynthesis;
let voices = [], chosenVoiceIndex = 0;
function loadVoices(){ voices = synth ? synth.getVoices() : []; if(voices.length>0){
 const nl = voices.findIndex(v=>v.lang && v.lang.startsWith('nl'));
 if(nl>=0) chosenVoiceIndex = nl; else chosenVoiceIndex = 0;
}}
if(synth){ loadVoices(); synth.onvoiceschanged = loadVoices; }
function hardResetTTS(){
 try{
   if(!synth) return;
   synth.cancel();
   if(synth.paused){ synth.resume(); }
   const u=new SpeechSynthesisUtterance(''); u.volume=0; synth.speak(u); synth.cancel();
 }catch(e){}
}
function stopAllTTS(){ try{ if(synth){ hardResetTTS(); } }catch(e){}
 document.querySelectorAll('.ttsImgBtn').forEach(btn=>{ const img = btn.querySelector('img'); if(img) img.src='speel.jpg'; btn.dataset.playing='false'; });
 showPlayIcon();
}
function speakOnce(text, opts={onstart:null,onend:null,pauseable:true,section:null}){
 if(!synth || !text) return;
 try{ hardResetTTS(); }catch(e){}
 const u = new SpeechSynthesisUtterance(text);
 const v = voices[chosenVoiceIndex];
 if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'nl-NL'; }
 u.rate = ('rate' in opts)? opts.rate : 0.95;
 u.pitch = ('pitch' in opts)? opts.pitch : 1.0;
 if(typeof opts.onstart==='function') u.onstart = opts.onstart;
 if(typeof opts.onend==='function') u.onend = opts.onend;
 synth.speak(u);
}

// Scene logica
const scenePlay = document.getElementById('scenePlay');
const scenePause = document.getElementById('scenePause');
let scenePlaying = false;
function showPauseIcon(){ if(scenePlay) scenePlay.classList.add('hidden'); if(scenePause) scenePause.classList.remove('hidden'); }
function showPlayIcon(){ if(scenePause) scenePause.classList.add('hidden'); if(scenePlay) scenePlay.classList.remove('hidden'); }
function enterSceneIntro(){ showPlayIcon(); const line1 = 'Als je de uitleg wil horen, klik je op de driehoek.'; speakOnce(line1,{onend:()=>{ showPlayIcon(); }}); }
function handleScenePlay(){
 if(scenePlaying){
   try{ synth.pause(); }catch(e){}
   scenePlaying=false; showPlayIcon(); return;
 }
 scenePlaying=true; showPauseIcon();
 const main = 'Klik rechtsonder op de knop';
 const emphas = 'volgende';
 speakOnce(main,{onend:()=>{
   speakOnce(emphas,{rate:0.9,pitch:1.6,onend:()=>{
     scenePlaying=false; showPlayIcon(); setNextEnabled(true);
   }});
 }});
 setNextEnabled(false);
}
function pauseScene(){ try{ synth.pause(); }catch(e){} scenePlaying=false; showPlayIcon(); }
if(scenePlay){ scenePlay.addEventListener('click', handleScenePlay); }
if(scenePause){ scenePause.addEventListener('click', pauseScene); }

function setNextEnabled(on){ nextBtn.disabled = !on; }
function normalizeClock(s){return s.toLowerCase().trim().replace('½','half').replace(/\s+/g,' ');} 
function check(ix){
 const t=tasks[ix];
 if(!t||t.dataset.kind!=='task') return true;
 const ans=t.dataset.answer;
 const input=t.querySelector('input.input');
 const fb=t.querySelector('div.feedback');
 let ok=false, value=null;
 if(input){
   value=input.value.trim();
   ok=(ans==='half 4'? normalizeClock(value).includes('half 4') : String(ans)===value);
 }else{
   const r=t.querySelector('input[type=radio]:checked');
   value=r ? r.value : null;
   ok= value && value===ans;
 }
 fb.textContent='';
 fb.className='feedback';
 if(value!==null && value!==''){
   state[ix].answered=true; state[ix].correct=ok; state[ix].value=value;
   if(ok && !t.dataset.counted){ score++; t.dataset.counted='1'; }
   if(!ok && t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
 }else{
   state[ix].answered=false; state[ix].correct=null;
   if(t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
 }
 renderPager();
 return state[ix].answered ? ok : false;
}

// Inject TTS image buttons voor tasks
function ensureTaskTTSControls(section){
 if(section.dataset.kind!=='task') return;
 if(!section.dataset.tts) return;
 const btn = section.querySelector('.ttsImgBtn'); if(!btn) return;
 const img = btn.querySelector('img'); if(!img) return;
 btn.dataset.playing='false';
 function onStart(){ btn.dataset.playing='true'; img.src='pauze.jpg'; }
 function onEnd(){ btn.dataset.playing='false'; img.src='speel.jpg'; }
 if(!btn._bound){
   btn.addEventListener('click', ()=>{
     const playing = btn.dataset.playing==='true';
     if(playing){ try{ synth.pause(); }catch(e){} btn.dataset.playing='false'; img.src='speel.jpg'; return; }
     onStart();
     const tts = section.dataset.tts || section.querySelector('.q')?.textContent || '';
     speakOnce(tts,{onend:()=>{ onEnd(); }});
   });
   btn._bound = true;
 }
}

function show(k){
 tasks.forEach((t,ix)=>t.classList.toggle('active', ix===k));
 const active = tasks[k];
 const kind = active?.dataset.kind;

 // Vorige alleen verbergen op het geluidscontrole-scherm
 if (kind === 'intro') { prevBtn.style.visibility = 'hidden'; } else { prevBtn.style.visibility = 'visible'; }

 const endSection = tasks.find(t=>t.dataset.kind==='end');
 if(endSection){
   if(kind==='end'){ endSection.classList.add('show'); document.body.classList.add('end-view'); }
   else { endSection.classList.remove('show'); document.body.classList.remove('end-view'); }
 }
 if(kind==='scene'){ document.body.classList.add('hide-ui'); } else { document.body.classList.remove('hide-ui'); }

 stopAllTTS();
 showPlayIcon();
 if(kind!=='intro'){ stopSoundLoop(); }

 if(kind==='task'){
   ensureTaskTTSControls(active);
   const firstInput = active.querySelector('input,textarea,select'); if(firstInput){ setTimeout(()=>firstInput.focus(), 50); }
   prevBtn.disabled = (itemIx.indexOf(k)===0);
   setNextEnabled(true);
   renderPager();
 }else if(kind==='intro'){
   const introText = active.dataset.tts || 'Controle van geluid. Druk op de knop met de driehoek. Als het geluid werkt druk je op het vierkantje.';
   speakOnce(introText);
   setNextEnabled(!!document.getElementById('soundOk')?.checked);
   renderPager(true);
 }else if(kind==='scene'){
   setNextEnabled(false);
   renderPager(true);
   enterSceneIntro();
 }else if(kind==='end'){
   fillEndCircles();
   setNextEnabled(false);
   renderPager(true);
 }
}

// Paginering
function renderPager(hideAll){
 pager.innerHTML='';
 if(hideAll){ return; }
 const total = itemIx.length; if(total===0) return;
 const currentIdx = itemIx.indexOf(i);
 for(let k=0;k<total;k++){
  const ixTask = itemIx[k];
  const b=document.createElement('button');
  const isCurrent = (currentIdx===k);
  b.className='pageBtn'+(isCurrent?' current':'')+(state[ixTask]?.answered && !isCurrent ? ' answered':'');
  b.type='button'; b.textContent=String(k+1);
  if(!isCurrent){ b.addEventListener('click', ()=>{ i=itemIx[k]; show(i); }); }
  pager.appendChild(b);
 }
}

// Eindscherm
function fillEndCircles(){
 const wrap=document.getElementById('endCircles');
 wrap.innerHTML='';
 itemIx.forEach((ix,idx)=>{
   const btn=document.createElement('button');
   btn.type='button';
   btn.className='circleBtn'+(state[ix].answered ? ' done' : '');
   btn.textContent=String(idx+1);
   btn.addEventListener('click', ()=>{ i=ix; show(i); });
   wrap.appendChild(btn);
 });
}

// Onderbalk knoppen
prevBtn.addEventListener('click', ()=>{
 const kind = tasks[i]?.dataset.kind;
 if(kind==='scene'){ i = introIx>=0 ? introIx : i; show(i); return; }
 if(kind==='intro'){ return; }
 const idx=itemIx.indexOf(i);
 const prev = itemIx[idx-1];
 if(prev!==undefined){ i=prev; show(i); }
});
nextBtn.addEventListener('click', ()=>{
 const kind = tasks[i].dataset.kind;
 if(kind==='intro'){
   if(!document.getElementById('soundOk').checked) return;
   i = sceneIx>=0 ? sceneIx : i; show(i); return;
 }
 if(kind==='scene'){
   i = firstTask>=0 ? firstTask : i; show(i); return;
 }
 if(kind==='task'){
   check(i);
   const idx=itemIx.indexOf(i);
   const next = itemIx[idx+1];
   if(next!==undefined){
     i=next; show(i);
   } else {
     i = tasks.findIndex(t=>t.dataset.kind==='end');
     if(i<0) i=tasks.length-1;
     show(i);
   }
   return;
 }
});

// Keyboard
window.addEventListener('keydown', (e)=>{
 const kind = tasks[i]?.dataset.kind;
 if(kind==='task'){
   if(e.key==='ArrowRight'){ e.preventDefault(); nextBtn.click(); }
   if(e.key==='ArrowLeft'){ e.preventDefault(); prevBtn.click(); }
   if(e.key.toLowerCase()==='p'){ e.preventDefault(); const btn=tasks[i].querySelector('.ttsImgBtn'); if(btn){ btn.click(); } }
 }
 if(kind==='intro' && e.key==='Enter'){ e.preventDefault(); nextBtn.click(); }
});

// Inputs, direct check
itemIx.forEach(ix=>{
 const node = tasks[ix];
 node.addEventListener('input', ()=>{ check(ix); });
 node.addEventListener('change', ()=>{ check(ix); });
});

// Geluidstest
const soundOk=document.getElementById('soundOk');
const audioBtn=document.getElementById('audioPlay');
const AudioCtx=window.AudioContext||window.webkitAudioContext; let ctx=null;
function ensureCtx(){ if(!ctx&&AudioCtx){ ctx=new AudioCtx(); } }
const DRUM_PATTERN=[ {offset:0.0,freq:120,type:'sine'}, {offset:0.4,freq:300,type:'square'}, {offset:0.6,freq:800,type:'triangle'}, {offset:0.8,freq:120,type:'sine'} ];
function playDrum(time,freq=150,dur=0.2,type='sine'){
 const o=ctx.createOscillator(); const g=ctx.createGain();
 o.connect(g); g.connect(ctx.destination);
 o.type=type; o.frequency.setValueAtTime(freq,time);
 g.gain.setValueAtTime(1,time); g.gain.exponentialRampToValueAtTime(0.001,time+dur);
 o.start(time); o.stop(time+dur);
}
function playDrumPatternAt(now){ DRUM_PATTERN.forEach(p=> playDrum(now+p.offset,p.freq,0.15,p.type)); }
let soundLoopTimeouts=[];
function stopSoundLoop(){
 soundLoopTimeouts.forEach(id=> clearTimeout(id));
 soundLoopTimeouts=[];
 if(audioBtn){ audioBtn.innerHTML = originalAudioBtnHTML; }
}
function playDrumPatternRepeated(times=3, gapMs=900){
 ensureCtx(); if(!ctx) return;
 stopSoundLoop();
 for(let r=0;r<times;r++){
   const tId = setTimeout(()=>{ const now = ctx.currentTime; playDrumPatternAt(now); }, r*gapMs);
   soundLoopTimeouts.push(tId);
 }
}
function updateIntro(){
 if(tasks[i]?.dataset.kind==='intro'){
   setNextEnabled(!!soundOk.checked);
   if(soundOk.checked){ stopSoundLoop(); }
 }
}
soundOk.addEventListener('change', updateIntro);
const originalAudioBtnHTML = audioBtn ? audioBtn.innerHTML : '';
if(audioBtn){
 audioBtn.addEventListener('click', ()=>{
   const loops=4, gap=1000;
   playDrumPatternRepeated(loops, gap);
   audioBtn.innerHTML = '<img src="pauze.jpg" alt="Pauze">';
   const totalMs = loops*gap + 200;
   setTimeout(()=>{
     if(tasks[i]?.dataset.kind==='intro'){ audioBtn.innerHTML = originalAudioBtnHTML; }
   }, totalMs);
 });
}

// Start
function init(){
 document.querySelectorAll('.task').forEach(sec=> ensureTaskTTSControls(sec));
 i = 0; show(i);
}
init();
})();
</script>
</body>
</html>
 
