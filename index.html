<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voorbeeldtoets Groep 3, Oefenomgeving</title>
<style>
  :root{
    --bg:#f2f2f2; --panel:#fff; --blue:#0d6efd; --blue-dark:#0b5ed7; --line:#e6e6e6;
    --text:#000; --muted:#666; --ok:#2fb073; --wrong:#b02f2f; --amber:#c58a00;
  }
  html,body{height:100%;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;font-size:16px;color:var(--text);background:var(--bg)}
  .sky{height:70px;background:var(--blue);border-bottom:2px solid var(--line)}

  .stage{display:flex;justify-content:center;align-items:flex-start;padding:40px 16px 120px}
  .card{background:var(--panel);width:960px;min-height:620px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.08);padding:24px 28px;position:relative;overflow:hidden}

  h1{font-size:20px;font-weight:bold;margin:0 0 14px;line-height:1.4}
  p{font-size:16px;line-height:1.5;margin:0 0 10px}
  .q{font-size:17px;font-weight:bold;margin:14px 0 8px}

  .input{font-size:16px;padding:8px 10px;border-radius:6px;border:1px solid #bbb;width:220px}
  .choices{margin-top:6px}
  .choice{display:block;margin-bottom:6px}

  .feedback{margin-top:8px;font-weight:bold}
  .ok{color:var(--ok)}
  .wrong{color:var(--wrong)}

  /* Weghalen van de oude voortgang rechtsboven */
  .progress{display:none !important}

  .audioBtn{border:0;background:#eee;width:40px;height:40px;border-radius:20px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .audioBtn svg{width:18px;height:18px;fill:var(--blue)}

  .task{display:none}
  .task.active{display:block}

  /* Nieuwe TTS knoppen per opdracht, boven de opdracht */
  .ttsControls{display:none;margin:6px 0 8px}
  .ttsControls.show{display:flex;gap:8px;align-items:center}
  .playTTS,.pauseTTS{border:0;background:#eee;border-radius:18px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
  .playTTS svg,.pauseTTS svg{width:12px;height:12px;fill:#333}
  .pauseTTS.hidden,.playTTS.hidden{display:none}

  .inner-panel{background:#fff;border-radius:16px;box-shadow:inset 0 0 0 1px #eee;margin:10px auto 0;width:820px;height:360px;position:relative;overflow:hidden}

  .scene-play,.scene-pause{position:absolute;left:50%;top:36px;transform:translateX(-50%);width:58px;height:58px;border:0;background:transparent;padding:0;cursor:pointer}
  .scene-play img,.scene-pause img{width:100%;height:100%;display:block}
  .scene-pause.hidden,.scene-play.hidden{display:none}

  .scene-boy{position:absolute;left:50%;top:120px;transform:translateX(-50%);height:170px;width:auto}
  .scene-girl{position:absolute;right:34px;bottom:22px;height:190px;width:auto}

  .hidden{display:none}

  .hide-ui .progress{display:none}

  /* Bovenste balk alleen voor Markeer */
  .toolbar{display:none;justify-content:space-between;align-items:center;margin:10px 0 2px}
  .toolbar.show{display:flex}
  .btn{border:1px solid #d0d0d0;background:#fff;border-radius:8px;padding:10px 14px;font-weight:bold;cursor:pointer}
  .btn:hover{background:#f4f6ff}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .flag{display:inline-flex;gap:8px;align-items:center;border:1px solid #e8e0c7;background:#fff8e1;color:#6a4e00;border-radius:8px;padding:8px 10px;cursor:pointer}
  .flag svg{width:16px;height:16px}
  .flag.active{background:#ffe8ad;border-color:#f2d074}

  /* Eindoverzicht, nieuwe stijl */
  .review{display:none}
  .review.show{display:block}
  .review h1{margin-bottom:6px}
  .review .note{margin:4px 0 12px;color:#444}

  /* Onderbalk zoals Cito */
  .bottomNav{
    position:absolute;left:18px;right:18px;bottom:18px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    background:#fafafa;border:1px solid #ececec;border-radius:12px;padding:10px 12px;
  }
  .bottomNav.hidden{display:none}

  .navBtn{
    border:0;background:var(--blue);color:#fff;border-radius:10px;padding:10px 18px;
    font-weight:bold;cursor:pointer
  }
  .navBtn[disabled]{
    background:#e0e0e0;color:#666;border:1px solid #d0d0d0;cursor:not-allowed;opacity:1;
  }

  .pager{display:flex;align-items:center;gap:8px;justify-content:center;flex:1;flex-wrap:wrap}
  .pageBtn{
    width:44px;height:44px;border-radius:22px;border:1px solid #d7d7d7;background:#fff;
    display:inline-flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;
    padding:0;line-height:1;
  }
  .pageBtn.current{
    width:56px;height:56px;border-radius:28px;font-size:18px;
    background:var(--blue);color:#fff;border-color:var(--blue);
  }
  /* Grijskleur zodra er antwoord is gegeven */
  .pageBtn.answered:not(.current){
    background:#e9e9e9;border-color:#d0d0d0;color:#333;
  }
  .ellipsis{padding:0 6px;color:#777;user-select:none}

  /* Rondjes op het eindscherm */
  .review .pager{gap:10px}
  .review .pageBtn{width:50px;height:50px;border-radius:25px}
  .review .pageBtn.current{width:50px;height:50px;border-radius:25px;font-size:16px}
</style>
</head>
<body>
  <div class="sky"></div>
  <div class="stage">
    <main class="card">

      <!-- Bovenste toolbar, alleen Markeer -->
      <div id="toolbar" class="toolbar" aria-label="Bediening">
        <div></div>
        <button id="flagBtn" class="flag" aria-pressed="false" aria-label="Markeer deze opgave">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 3h10l-1 3h4l-1 3h-7l-1 3H6v9H4V3z"/></svg>
          Markeer
        </button>
      </div>

      <!-- 1. Intro -->
      <section class="task active" data-kind="intro" data-tts="Controle van het geluid, klik op de knop om het geluid te horen, vink daarna het vakje aan als je het hoort">
        <h1>Controle van het geluid</h1>
        <p><button id="audioPlay" class="audioBtn" aria-label="Speel geluid">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button></p>
        <p class="q"><label><input type="checkbox" class="check" id="soundOk"> Het geluid werkt</label></p>
        <p class="q">Werkt het niet, meld dit aan je docent.</p>
      </section>

      <!-- 2. Scene -->
      <section class="task" data-kind="scene" data-tts="">
        <h1>Luisteren naar de uitleg</h1>
        <div class="inner-panel" aria-label="Uitlegscherm">
          <img src="jongetje.jpg" alt="Jongen" class="scene-boy">
          <img src="meisje.jpg" alt="Meisje" class="scene-girl">
          <button id="scenePlay" class="scene-play" aria-label="Afspelen" title="Afspelen">
            <img src="speel.jpg" alt="Afspelen">
          </button>
          <button id="scenePause" class="scene-pause hidden" aria-label="Pauzeer" title="Pauzeer">
            <img src="pauze.jpg" alt="Pauze">
          </button>
        </div>
      </section>

      <!-- 3. Opgaven -->
      <section class="task" data-kind="task" data-answer="7" data-tts="Opgave 1, splits dertien in twee delen, het eerste deel is zes, wat is het tweede deel">
        <div class="ttsControls" aria-hidden="true"></div>
        <h1>Opgave 1</h1>
        <p class="q">Splits 13 in twee delen. Het eerste deel is 6. Wat is het tweede deel</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="11" data-tts="Opgave 2, reken uit, zeven plus zes min twee is hoeveel">
        <div class="ttsControls" aria-hidden="true"></div>
        <h1>Opgave 2</h1>
        <p class="q">Reken uit, 7 plus 6, 2 eraf is hoeveel</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="half 4" data-tts="Opgave 3, de grote wijzer staat op zes, de kleine wijzer staat tussen drie en vier, hoe laat is het">
        <div class="ttsControls" aria-hidden="true"></div>
        <h1>Opgave 3</h1>
        <p class="q">De grote wijzer staat op 6, de kleine wijzer staat tussen 3 en 4. Hoe laat is het</p>
        <input class="input" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="b" data-tts="Opgave 4, lees, de poes slaapt op de mat, waar ligt de poes">
        <div class="ttsControls" aria-hidden="true"></div>
        <h1>Opgave 4</h1>
        <p class="q">Lees, De poes slaapt op de <strong>mat</strong>. Waar ligt de poes</p>
        <div class="choices">
          <label class="choice"><input type="radio" name="q4" value="a"> op de kast</label>
          <label class="choice"><input type="radio" name="q4" value="b"> op de mat</label>
          <label class="choice"><input type="radio" name="q4" value="c"> in de doos</label>
        </div>
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="85" data-tts="Opgave 5, een appel kost vijfendertig cent, een banaan kost vijftig cent, hoeveel cent samen">
        <div class="ttsControls" aria-hidden="true"></div>
        <h1>Opgave 5</h1>
        <p class="q">Een appel kost 35 cent, een banaan kost 50 cent. Hoeveel cent samen</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <!-- 4. Eindscherm, nieuwe tekst en nieuwe rondjesweergave -->
      <section class="task review" data-kind="end" data-tts="">
        <h1>Klaar</h1>
        <p class="note">Je bent nu bij het eindscherm.</p>
        <p class="note">Controleer of je alle opdrachten hebt gemaakt.</p>

        <!-- Rondjes met opgavenummers, klikbaar -->
        <div id="reviewPager" class="pager" aria-label="Overzicht opgaven"></div>
      </section>

      <!-- Onderbalk -->
      <div class="bottomNav" aria-label="Navigatie onder">
        <button id="prevBtn" class="navBtn" aria-label="Vorige">Vorige</button>
        <div id="pager" class="pager" aria-label="Opgaven"></div>
        <button id="nextBtn" class="navBtn" aria-label="Volgende">Volgende</button>
      </div>

    </main>
  </div>

<script>
(function(){
  const tasks=[...document.querySelectorAll('.task')];
  const toolbar=document.getElementById('toolbar');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const flagBtn=document.getElementById('flagBtn');
  const pager=document.getElementById('pager');
  const bottomNav=document.querySelector('.bottomNav');
  const reviewPager=document.getElementById('reviewPager');

  // indices
  const taskIndexes = tasks.map((t,ix)=>({ix, kind:t.dataset.kind}));
  const itemIx = taskIndexes.filter(x=>x.kind==='task').map(x=>x.ix);
  const firstTask = itemIx[0];
  const introIx = tasks.findIndex(t=>t.dataset.kind==='intro');
  const sceneIx = tasks.findIndex(t=>t.dataset.kind==='scene');

  // administratie
  let i=0, score=0;
  const state = itemIx.reduce((acc,ix)=>{
    acc[ix] = { answered:false, correct:null, flagged:false, value:null };
    return acc;
  },{});

  // TTS basis
  const synth = window.speechSynthesis;
  let voices = [], chosenVoiceIndex = 76;
  function loadVoices(){ voices = synth ? synth.getVoices() : []; }
  if(synth){ loadVoices(); synth.onvoiceschanged = loadVoices; }
  function isSpeaking(){ return synth && synth.speaking && !synth.paused; }
  function stopAllTTS(){ try{ if(synth){ synth.cancel(); } }catch(e){} }

  // Scene logica
  const scenePlay = document.getElementById('scenePlay');
  const scenePause = document.getElementById('scenePause');
  function showPauseIcon(){ scenePlay.classList.add('hidden'); scenePause.classList.remove('hidden'); }
  function showPlayIcon(){ scenePause.classList.add('hidden'); scenePlay.classList.remove('hidden'); }

  function enterSceneIntro(){
    showPlayIcon();
    const line1 = 'Als je de uitleg wil horen klik je op de driehoek.';
    const u = new SpeechSynthesisUtterance(line1);
    const v = voices[chosenVoiceIndex];
    if(v){ u.voice=v; u.lang=v.lang; } else { u.lang='nl-NL'; }
    u.rate=0.95; u.pitch=1.0;
    try{ synth.cancel(); }catch(e){}
    synth.speak(u);
  }

  function handleScenePlay(){
    const line2 = 'klik rechtsonder op de knop volgende om verder te gaan';
    const u = new SpeechSynthesisUtterance(line2);
    const v = voices[chosenVoiceIndex];
    if(v){ u.voice=v; u.lang=v.lang; } else { u.lang='nl-NL'; }
    u.rate=0.95; u.pitch=1.0;
    u.onstart=()=>{ showPauseIcon(); };
    u.onend=()=>{ showPlayIcon(); setNextEnabled(true); };
    try{ synth.cancel(); }catch(e){}
    setNextEnabled(false);
    synth.speak(u);
  }
  function pauseScene(){ try{ synth.pause(); }catch(e){} showPlayIcon(); }
  if(scenePlay){ scenePlay.addEventListener('click', handleScenePlay); }
  if(scenePause){ scenePause.addEventListener('click', pauseScene); }

  function setToolbarMode(mode){
    const hideFlag = (mode!=='task');
    flagBtn.classList.toggle('hidden', hideFlag);
    toolbar.classList.toggle('show', mode==='task');
  }
  function setNextEnabled(on){
    nextBtn.disabled = !on;
  }

  function normalizeClock(s){return s.toLowerCase().trim().replace('½','half').replace(/\s+/g,' ');}    

  // Nieuwe TTS per opdracht
  function buildTTSControlsForTasks(){
    itemIx.forEach(ix=>{
      const t=tasks[ix];
      const hasTTS = !!t.dataset.tts;
      const holder = t.querySelector('.ttsControls');
      if(!holder) return;
      if(!hasTTS){ holder.classList.remove('show'); holder.innerHTML=''; return; }

      holder.innerHTML = `
        <button class="playTTS" aria-label="Speel uitleg" title="Speel uitleg">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          Afspelen
        </button>
        <button class="pauseTTS hidden" aria-label="Pauzeer voorlezen" title="Pauzeer voorlezen">
          <svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
          Pauze
        </button>
      `;
      holder.classList.add('show');

      const playBtn = holder.querySelector('.playTTS');
      const pauseBtn = holder.querySelector('.pauseTTS');

      function speakTask(){
        const text = t.dataset.tts || '';
        if(!text) return;
        try{ synth.cancel(); }catch(e){}
        const u = new SpeechSynthesisUtterance(text);
        const v = voices[chosenVoiceIndex];
        if(v){ u.voice=v; u.lang=v.lang; } else { u.lang='nl-NL'; }
        u.rate=0.95; u.pitch=1.0;
        u.onstart = ()=>{ playBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden'); };
        u.onend = ()=>{ pauseBtn.classList.add('hidden'); playBtn.classList.remove('hidden'); };
        synth.speak(u);
      }
      playBtn.addEventListener('click', ()=>{
        if(synth && synth.paused){ try{ synth.resume(); }catch(e){}; playBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden'); }
        else { speakTask(); }
      });
      pauseBtn.addEventListener('click', ()=>{
        if(isSpeaking()){ try{ synth.pause(); }catch(e){}; pauseBtn.classList.add('hidden'); playBtn.classList.remove('hidden'); }
      });
    });
  }

  // Nakijken
  function check(ix){
    const t=tasks[ix];
    if(!t||t.dataset.kind!=='task') return true;
    const ans=t.dataset.answer;
    const input=t.querySelector('input.input');
    const fb=t.querySelector('div.feedback');
    let ok=false, value=null;

    if(input){
      value=input.value.trim();
      ok=(ans==='half 4'? normalizeClock(value).includes('half 4') : String(ans)===value);
    }else{
      const r=t.querySelector('input[type=radio]:checked');
      value=r ? r.value : null;
      ok= value && value===ans;
    }

    fb.textContent='';
    fb.className='feedback';

    if(value!==null && value!==''){
      state[ix].answered=true;
      state[ix].correct=ok;
      state[ix].value=value;
      if(ok && !t.dataset.counted){ score++; t.dataset.counted='1'; }
      if(!ok && t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
    }else{
      state[ix].answered=false;
      state[ix].correct=null;
      if(t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
    }

    renderPager();
    return state[ix].answered ? ok : false;
  }

  function show(k){
    tasks.forEach((t,ix)=>t.classList.toggle('active', ix===k));
    const active = tasks[k];
    const kind = active?.dataset.kind;

    // Eindscherm tonen of verbergen
    const endSection = tasks.find(t=>t.dataset.kind==='end');
    if(endSection){
      if(kind==='end'){ endSection.classList.add('show'); }
      else { endSection.classList.remove('show'); }
    }

    if(kind==='scene'){ document.body.classList.add('hide-ui'); }
    else { document.body.classList.remove('hide-ui'); }

    // stop TTS bij wisselen
    try{ synth.cancel(); }catch(e){}

    // stop geluidstest loop zodra intro uit beeld is
    if(kind!=='intro'){ stopSoundLoop(); }

    if(kind==='task'){
      setToolbarMode('task');
      bottomNav.classList.remove('hidden');
      const firstInput = active.querySelector('input,textarea,select');
      if(firstInput){ setTimeout(()=>firstInput.focus(), 50); }
      prevBtn.disabled = (itemIx.indexOf(k)===0);
      setNextEnabled(true);
      renderPager();

    }else if(kind==='intro'){
      setToolbarMode('intro');
      bottomNav.classList.remove('hidden');
      if(active.dataset.tts){ speakOnce(active.dataset.tts); }
      setNextEnabled(!!document.getElementById('soundOk')?.checked);
      renderPager(true);

    }else if(kind==='scene'){
      setToolbarMode('scene');
      bottomNav.classList.remove('hidden');
      setNextEnabled(false);
      renderPager(true);
      enterSceneIntro();

    }else if(kind==='end'){
      setToolbarMode('end');
      bottomNav.classList.add('hidden'); // knoppen Vorige en Volgende weg op eindscherm
      setNextEnabled(false);
      renderPager(true);
      buildReviewPager();
    }
  }

  // Paginering, altijd 1 en 2 zichtbaar, laatste zichtbaar, 2 blijft dus zichtbaar bij opdracht 5
  function renderPager(hideAll){
    pager.innerHTML='';
    if(hideAll){ return; }

    const total = itemIx.length;
    if(total===0) return;

    const currentIdx = itemIx.indexOf(i);
    const shown = new Set();

    const makeBtn = (label, taskIdxPos, current=false, answered=false)=>{
      const b=document.createElement('button');
      b.className='pageBtn'+(current?' current':'')+(answered&&!current?' answered':'');
      b.type='button';
      b.textContent=label;
      if(!current){
        b.addEventListener('click', ()=>{ i=itemIx[taskIdxPos]; show(i); });
      }
      pager.appendChild(b);
      shown.add(taskIdxPos);
    };
    const addEllipsis = ()=>{ const s=document.createElement('span'); s.className='ellipsis'; s.textContent='…'; pager.appendChild(s); };

    const totalTasks = itemIx.length;
    const lastPos = totalTasks-1;

    // altijd 1 en 2
    makeBtn('1', 0, currentIdx===0, state[itemIx[0]]?.answered);
    if(totalTasks>1){
      makeBtn('2', 1, currentIdx===1, state[itemIx[1]]?.answered);
    }

    // ellipsis indien er een gat is na 2
    if(currentIdx>4){ addEllipsis(); }

    // venster rond de huidige
    const start=Math.max(2, currentIdx-2);
    const end=Math.min(lastPos-1, currentIdx+3);
    for(let k=start; k<=end; k++){
      if(!shown.has(k)){
        makeBtn(String(k+1), k, k===currentIdx, state[itemIx[k]]?.answered);
      }
    }

    // ellipsis indien er een gat voor de laatste
    if(currentIdx<lastPos-4){ addEllipsis(); }

    // laatste
    if(!shown.has(lastPos)){
      makeBtn(String(lastPos+1), lastPos, currentIdx===lastPos, state[itemIx[lastPos]]?.answered);
    }
  }

  // Eindscherm, rondjes met grijs als af en wit als open
  function buildReviewPager(){
    reviewPager.innerHTML='';
    const total = itemIx.length;
    for(let pos=0; pos<total; pos++){
      const ix=itemIx[pos];
      const answered = !!state[ix]?.answered;
      const btn=document.createElement('button');
      btn.className='pageBtn';
      if(answered){ btn.classList.add('answered'); } // grijs indien af
      btn.textContent=String(pos+1);
      btn.type='button';
      btn.addEventListener('click', ()=>{ i=ix; show(i); });
      reviewPager.appendChild(btn);
    }
  }

  // Spreken op intro
  function speakOnce(text){
    if(!synth || !text) return;
    try{ synth.cancel(); }catch(e){}
    const u = new SpeechSynthesisUtterance(text);
    const v = voices[chosenVoiceIndex];
    if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'nl-NL'; }
    u.rate = 0.95; u.pitch = 1.0;
    synth.speak(u);
  }

  // keyboard
  window.addEventListener('keydown', (e)=>{
    const kind = tasks[i]?.dataset.kind;
    if(kind==='task'){
      if(e.key==='ArrowRight'){ e.preventDefault(); nextBtn.click(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); prevBtn.click(); }
      if(e.key.toLowerCase()==='m'){ e.preventDefault(); flagBtn.click(); }
    }
    if(kind==='intro' && e.key==='Enter'){ e.preventDefault(); nextBtn.click(); }
  });

  // inputs, direct check
  itemIx.forEach(ix=>{
    const node = tasks[ix];
    node.addEventListener('input', ()=>{ check(ix); });
    node.addEventListener('change', ()=>{ check(ix); });
  });

  // geluidstest
  const soundOk=document.getElementById('soundOk');
  const audioBtn=document.getElementById('audioPlay');
  const AudioCtx=window.AudioContext||window.webkitAudioContext; let ctx=null;
  function ensureCtx(){ if(!ctx&&AudioCtx){ ctx=new AudioCtx(); } }

  const DRUM_PATTERN=[
    {offset:0.0,freq:120,type:'sine'},
    {offset:0.4,freq:300,type:'square'},
    {offset:0.6,freq:800,type:'triangle'},
    {offset:0.8,freq:120,type:'sine'}
  ];

  function playDrum(time,freq=150,dur=0.2,type='sine'){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type=type; o.frequency.setValueAtTime(freq,time);
    g.gain.setValueAtTime(1,time); g.gain.exponentialRampToValueAtTime(0.001,time+dur);
    o.start(time); o.stop(time+dur);
  }
  function playDrumPatternAt(now){
    DRUM_PATTERN.forEach(p=> playDrum(now+p.offset,p.freq,0.15,p.type));
  }
  let soundLoopTimeouts=[];
  function stopSoundLoop(){
    soundLoopTimeouts.forEach(id=> clearTimeout(id));
    soundLoopTimeouts=[];
  }
  function playDrumPatternRepeated(times=3, gapMs=900){
    ensureCtx(); if(!ctx) return;
    stopSoundLoop();
    for(let r=0;r<times;r++){
      const tId = setTimeout(()=>{
        const now = ctx.currentTime;
        playDrumPatternAt(now);
      }, r*gapMs);
      soundLoopTimeouts.push(tId);
    }
  }
  function updateIntro(){
    if(tasks[i]?.dataset.kind==='intro'){
      setNextEnabled(!!soundOk.checked);
      if(soundOk.checked){ stopSoundLoop(); }
    }
  }
  if(soundOk){ soundOk.addEventListener('change', updateIntro); }
  if(audioBtn){ audioBtn.addEventListener('click', ()=> playDrumPatternRepeated(4, 1000)); }

  // start
  function init(){
    i = 0;
    setToolbarMode('intro');
    buildTTSControlsForTasks();
    show(i);
  }
  init();

})();
</script>
</body>
</html>
