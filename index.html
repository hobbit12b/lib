<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voorbeeldtoets Groep 3, Oefenomgeving</title>
<style>
  :root{
    --bg:#f2f2f2; --panel:#fff; --blue:#0d6efd; --blue-dark:#0b5ed7; --line:#e6e6e6;
    --text:#000; --muted:#666; --ok:#2fb073; --wrong:#b02f2f; --amber:#c58a00;
  }
  html,body{height:100%;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;font-size:16px;color:var(--text);background:var(--bg)}
  .sky{height:70px;background:var(--blue);border-bottom:2px solid var(--line)}

  .stage{display:flex;justify-content:center;align-items:flex-start;padding:40px 16px 120px}
  .card{background:var(--panel);width:960px;min-height:620px;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,.08);padding:24px 28px;position:relative;overflow:hidden}

  h1{font-size:20px;font-weight:bold;margin:0 0 14px;line-height:1.4}
  p{font-size:16px;line-height:1.5;margin:0 0 10px}
  .q{font-size:17px;font-weight:bold;margin:14px 0 8px}

  .input{font-size:16px;padding:8px 10px;border-radius:6px;border:1px solid #bbb;width:220px}
  .choices{margin-top:6px}
  .choice{display:block;margin-bottom:6px}

  .feedback{margin-top:8px;font-weight:bold}
  .ok{color:var(--ok)}
  .wrong{color:var(--wrong)}

  .progress{position:absolute;top:18px;right:22px;font-size:13px;color:#555;display:flex;gap:8px;align-items:center}

  .audioBtn{border:0;background:#eee;width:40px;height:40px;border-radius:20px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .audioBtn svg{width:18px;height:18px;fill:var(--blue)}

  .task{display:none}
  .task.active{display:block}

  .pauseTTS{border:0;background:#eee;border-radius:18px;padding:6px 10px;display:none;align-items:center;gap:6px;cursor:pointer}
  .pauseTTS svg{width:12px;height:12px;fill:#333}
  .pauseTTS.show{display:inline-flex}

  .inner-panel{background:#fff;border-radius:16px;box-shadow:inset 0 0 0 1px #eee;margin:10px auto 0;width:820px;height:360px;position:relative;overflow:hidden}

  .scene-play,.scene-pause{position:absolute;left:50%;top:36px;transform:translateX(-50%);width:58px;height:58px;border:0;background:transparent;padding:0;cursor:pointer}
  .scene-play img,.scene-pause img{width:100%;height:100%;display:block}
  .scene-pause.hidden,.scene-play.hidden{display:none}

  .scene-boy{position:absolute;left:50%;top:120px;transform:translateX(-50%);height:170px;width:auto}
  .scene-girl{position:absolute;right:34px;bottom:22px;height:190px;width:auto}

  .hidden{display:none}

  .hide-ui .progress{display:none}
  .hide-ui .pauseTTS{display:none}

  /* Bovenste balk alleen voor Markeer */
  .toolbar{display:none;justify-content:space-between;align-items:center;margin:10px 0 2px}
  .toolbar.show{display:flex}
  .btn{border:1px solid #d0d0d0;background:#fff;border-radius:8px;padding:10px 14px;font-weight:bold;cursor:pointer}
  .btn:hover{background:#f4f6ff}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .flag{display:inline-flex;gap:8px;align-items:center;border:1px solid #e8e0c7;background:#fff8e1;color:#6a4e00;border-radius:8px;padding:8px 10px;cursor:pointer}
  .flag svg{width:16px;height:16px}
  .flag.active{background:#ffe8ad;border-color:#f2d074}

  /* Eindoverzicht */
  .review{display:none}
  .review.show{display:block}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:10px;margin:14px 0}
  .tile{border:1px solid #ddd;border-radius:10px;padding:10px;text-align:center;cursor:pointer;background:#fff}
  .tile .nr{font-weight:bold;font-size:18px}
  .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;margin-top:6px}
  .pill.ok{background:#e9f7f0;color:#1e7e52}
  .pill.wrong{background:#fdeaea;color:#a33939}
  .pill.open{background:#eef2ff;color:#3146a8}
  .legendRow{display:flex;gap:12px;font-size:13px;color:#555;margin:10px 0 18px}
  .legendRow span{display:inline-flex;align-items:center;gap:6px}
  .swatch{width:10px;height:10px;border-radius:2px;display:inline-block}
  .sw-ok{background:#bfe6cf}
  .sw-wrong{background:#f1c4c4}
  .sw-open{background:#d6dcff}

  /* Onderbalk zoals Cito */
  .bottomNav{
    position:absolute;left:18px;right:18px;bottom:18px;
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    background:#fafafa;border:1px solid #ececec;border-radius:12px;padding:10px 12px;
  }
  .navBtn{
    border:0;background:var(--blue);color:#fff;border-radius:10px;padding:10px 18px;
    font-weight:bold;cursor:pointer
  }
  /* Grijs bij uitgeschakeld, duidelijk zichtbaar */
  .navBtn[disabled]{
    background:#e0e0e0;color:#666;border:1px solid #d0d0d0;cursor:not-allowed;opacity:1;
  }
  .pager{display:flex;align-items:center;gap:8px;justify-content:center;flex:1}
  .pageBtn{
    width:44px;height:44px;border-radius:22px;border:1px solid #d7d7d7;background:#fff;
    display:inline-flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;
    padding:0;line-height:1;
  }
  /* Grotere huidige cirkel, zoals Cito */
  .pageBtn.current{
    width:56px;height:56px;border-radius:28px;font-size:18px;
    background:var(--blue);color:#fff;border-color:var(--blue);
  }
  .ellipsis{padding:0 6px;color:#777;user-select:none}
</style>
</head>
<body>
  <div class="sky"></div>
  <div class="stage">
    <main class="card">
      <div class="progress" id="progressWrap">
        <span id="progress">1 / 8</span>
        <button id="ttsPause" class="pauseTTS" aria-label="Pauzeer voorlezen" title="Pauzeer voorlezen">
          <svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
          Pauze
        </button>
      </div>

      <!-- Bovenste toolbar, alleen Markeer -->
      <div id="toolbar" class="toolbar" aria-label="Bediening">
        <div></div>
        <button id="flagBtn" class="flag" aria-pressed="false" aria-label="Markeer deze opgave">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 3h10l-1 3h4l-1 3h-7l-1 3H6v9H4V3z"/></svg>
          Markeer
        </button>
      </div>

      <!-- 1. Intro -->
      <section class="task active" data-kind="intro" data-tts="Controle van het geluid, klik op de knop om het geluid te horen, vink daarna het vakje aan als je het hoort">
        <h1>Controle van het geluid</h1>
        <p><button id="audioPlay" class="audioBtn" aria-label="Speel geluid">
          <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button></p>
        <p class="q"><label><input type="checkbox" class="check" id="soundOk"> Het geluid werkt</label></p>
        <p class="q">Werkt het niet, meld dit aan je docent.</p>
      </section>

      <!-- 2. Scene -->
      <section class="task" data-kind="scene" data-tts="">
        <h1>Luisteren naar de uitleg</h1>
        <div class="inner-panel" aria-label="Uitlegscherm">
          <img src="jongetje.jpg" alt="Jongen" class="scene-boy">
          <img src="meisje.jpg" alt="Meisje" class="scene-girl">
          <button id="scenePlay" class="scene-play" aria-label="Afspelen" title="Afspelen">
            <img src="speel.jpg" alt="Afspelen">
          </button>
          <button id="scenePause" class="scene-pause hidden" aria-label="Pauzeer" title="Pauzeer">
            <img src="pauze.jpg" alt="Pauze">
          </button>
        </div>
      </section>

      <!-- 3. Opgaven -->
      <section class="task" data-kind="task" data-answer="7" data-tts="Opgave 1, splits dertien in twee delen, het eerste deel is zes, wat is het tweede deel">
        <h1>Opgave 1</h1>
        <p class="q">Splits 13 in twee delen. Het eerste deel is 6. Wat is het tweede deel</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="11" data-tts="Opgave 2, reken uit, zeven plus zes min twee is hoeveel">
        <h1>Opgave 2</h1>
        <p class="q">Reken uit, 7 plus 6, 2 eraf is hoeveel</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="half 4" data-tts="Opgave 3, de grote wijzer staat op zes, de kleine wijzer staat tussen drie en vier, hoe laat is het">
        <h1>Opgave 3</h1>
        <p class="q">De grote wijzer staat op 6, de kleine wijzer staat tussen 3 en 4. Hoe laat is het</p>
        <input class="input" />
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="b" data-tts="Opgave 4, lees, de poes slaapt op de mat, waar ligt de poes">
        <h1>Opgave 4</h1>
        <p class="q">Lees, De poes slaapt op de <strong>mat</strong>. Waar ligt de poes</p>
        <div class="choices">
          <label class="choice"><input type="radio" name="q4" value="a"> op de kast</label>
          <label class="choice"><input type="radio" name="q4" value="b"> op de mat</label>
          <label class="choice"><input type="radio" name="q4" value="c"> in de doos</label>
        </div>
        <div class="feedback"></div>
      </section>

      <section class="task" data-kind="task" data-answer="85" data-tts="Opgave 5, een appel kost vijfendertig cent, een banaan kost vijftig cent, hoeveel cent samen">
        <h1>Opgave 5</h1>
        <p class="q">Een appel kost 35 cent, een banaan kost 50 cent. Hoeveel cent samen</p>
        <input class="input" inputmode="numeric" />
        <div class="feedback"></div>
      </section>

      <!-- 4. Eindscherm -->
      <section class="task review" data-kind="end" data-tts="Klaar, goed gedaan, je hebt alle vijf de opgaven gemaakt">
        <h1>Klaar</h1>
        <p>Goed gedaan. Je hebt alle vijf de opgaven doorlopen.</p>
        <p class="q">Jouw score, <span id="score">0</span> / <span id="total">0</span></p>

        <div class="legendRow">
          <span><span class="swatch sw-open"></span> open</span>
          <span><span class="swatch sw-ok"></span> goed</span>
          <span><span class="swatch sw-wrong"></span> onjuist</span>
          <span>⚑ gemarkeerd</span>
        </div>

        <div id="reviewGrid" class="grid" aria-label="Overzicht opgaven"></div>
        <div style="margin-top:8px">
          <button id="toFirstOpen" class="btn">Ga naar eerste open opgave</button>
        </div>
      </section>

      <!-- Onderbalk -->
      <div class="bottomNav" aria-label="Navigatie onder">
        <button id="prevBtn" class="navBtn" aria-label="Vorige">Vorige</button>
        <div id="pager" class="pager" aria-label="Opgaven"></div>
        <button id="nextBtn" class="navBtn" aria-label="Volgende">Volgende</button>
      </div>

    </main>
  </div>

<script>
(function(){
  const tasks=[...document.querySelectorAll('.task')];
  const progress=document.getElementById('progress');
  const ttsPause=document.getElementById('ttsPause');
  const toolbar=document.getElementById('toolbar');
  const prevBtn=document.getElementById('prevBtn');
  const nextBtn=document.getElementById('nextBtn');
  const flagBtn=document.getElementById('flagBtn');
  const pager=document.getElementById('pager');

  // dynamische TTS play-knop (driehoek) naast pauze
  const progressWrap=document.getElementById('progressWrap');
  const ttsPlay=document.createElement('button');
  ttsPlay.id='ttsPlay';
  ttsPlay.className='pauseTTS';
  ttsPlay.setAttribute('aria-label','Speel voorlezen');
  ttsPlay.title='Speel voorlezen';
  ttsPlay.innerHTML='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Speel';
  progressWrap.appendChild(ttsPlay);

  // indices
  const taskIndexes = tasks.map((t,ix)=>({ix, kind:t.dataset.kind}));
  const itemIx = taskIndexes.filter(x=>x.kind==='task').map(x=>x.ix);
  const firstTask = itemIx[0];
  const introIx = tasks.findIndex(t=>t.dataset.kind==='intro');
  const sceneIx = tasks.findIndex(t=>t.dataset.kind==='scene');

  // administratie
  let i=0, score=0;
  const state = itemIx.reduce((acc,ix)=>{
    acc[ix] = { answered:false, correct:null, flagged:false, value:null };
    return acc;
  },{});

  // TTS basis
  const synth = window.speechSynthesis;
  let voices = [], chosenVoiceIndex = 76;
  function loadVoices(){ voices = synth ? synth.getVoices() : []; }
  if(synth){ loadVoices(); synth.onvoiceschanged = loadVoices; }
  function stopAllTTS(){ try{ if(synth){ synth.cancel(); } }catch(e){} hideTTSPause(); } }catch(e){} ttsPause.classList.remove('show'); }
  function speakOnce(text){
    if(!synth || !text) return;
    stopAllTTS();
    const u = new SpeechSynthesisUtterance(text);
    const v = voices[chosenVoiceIndex];
    if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'nl-NL'; }
    u.rate = 0.95; u.pitch = 1.0;
    u.onstart = ()=> { showTTSPause(); };
    u.onend = ()=> { const active = tasks[i]; if(active?.dataset.kind==='task'){ showTTSPlay(); } else { hideTTSControls(); } };
    synth.speak(u);
  }

  // Scene queue, met wissel van play naar pauze en terug
  // Scene: uitleg van het geluid
  const sceneIntroText = "Als je de uitleg wil horen klik je op de driehoek.";
  const sceneNextHint = "klik rechtsonder op de knop volgende om verder te gaan";
  const sceneState = { autoPlayed:false, hintPlayed:false, playing:false, paused:false, done:false };

  const scenePlay = document.getElementById('scenePlay');
  const scenePause = document.getElementById('scenePause');

  function showPauseIcon(){ scenePlay.classList.add('hidden'); scenePause.classList.remove('hidden'); }
  function showPlayIcon(){ scenePause.classList.add('hidden'); scenePlay.classList.remove('hidden'); }

  function makeU(text,onend){
    const u = new SpeechSynthesisUtterance(text);
    const v = voices[chosenVoiceIndex];
    if(v){ u.voice = v; u.lang = v.lang; } else { u.lang = 'nl-NL'; }
    u.rate=0.95; u.pitch=1.0; u.onstart=()=>ttsPause.classList.add('show'); u.onend=onend; return u;
  }
  function startSceneFromBeginning(){
    stopAllTTS();
    sceneState.autoPlayed=false; sceneState.hintPlayed=false;
    sceneState.playing=true; sceneState.paused=false; sceneState.done=false;
    setNextEnabled(false);
    // start automatisch: introzin
    showPauseIcon();
    const u = makeU(sceneIntroText, ()=>{
      sceneState.autoPlayed=true; sceneState.playing=false; sceneState.paused=false;
      ttsPause.classList.remove('show');
      showPlayIcon();
      // Na de intro is de play-knop zichtbaar, Next blijft uit tot hint is afgespeeld
    });
    synth.speak(u);
  }
  function speakNextInScene(){ /* niet meer gebruikt, vervangen door tweefasenlogica */ }
    const text=sceneState.queue[sceneState.index];
    const u=makeU(text,()=>{
      sceneState.index+=1;
      if(sceneState.playing && !sceneState.paused){ setTimeout(speakNextInScene,350); }
    });
    synth.speak(u);
  }
  function pauseScene(){
    if(!sceneState.playing||sceneState.paused) return;
    try{ synth.pause(); }catch(e){}
    sceneState.paused=true;
    setNextEnabled(false);
    showPlayIcon();
    ttsPause.classList.remove('show');
  }
  function resumeScene(){
    // Als we gepauzeerd zijn, hervatten
    if(sceneState.paused && sceneState.playing){
      sceneState.paused=false;
      try{ synth.resume(); }catch(e){}
      setNextEnabled(false);
      showPauseIcon();
      return;
    }
    // Als de auto-intro klaar is maar de hint nog niet is gespeeld: speel de hint
    if(sceneState.autoPlayed && !sceneState.hintPlayed){
      stopAllTTS();
      sceneState.playing=true; sceneState.paused=false;
      showPauseIcon();
      const u = makeU(sceneNextHint, ()=>{
        sceneState.hintPlayed=true; sceneState.playing=false; sceneState.done=true;
        ttsPause.classList.remove('show');
        setNextEnabled(true);
        showPlayIcon();
      });
      synth.speak(u);
      return;
    }
    // Anders: alles opnieuw vanaf het begin
    startSceneFromBeginning();
  }catch(e){}
      setNextEnabled(false);
      showPauseIcon();
      return;
    }
    startSceneFromBeginning();
  }
  if(scenePlay){ scenePlay.addEventListener('click', resumeScene); }
  if(scenePause){ scenePause.addEventListener('click', pauseScene); }
  ttsPause.addEventListener('click', ()=>{ const kind = tasks[i]?.dataset.kind; if(kind==='scene'){ pauseScene(); } else { try{ synth.pause(); }catch(e){} showTTSPlay(); }});
  ttsPlay.addEventListener('click', ()=>{
    const active = tasks[i];
    if(active?.dataset.kind==='task' && active.dataset.tts){ setNextEnabled(true); speakOnce(active.dataset.tts); }
    if(active?.dataset.kind==='scene'){ resumeScene(); }
  });

  function showTTSPause(){ ttsPause.classList.add('show'); ttsPlay.classList.remove('show'); }
  function hideTTSPause(){ ttsPause.classList.remove('show'); }
  function showTTSPlay(){ ttsPlay.classList.add('show'); hideTTSPause(); }
  function hideTTSControls(){ ttsPlay.classList.remove('show'); hideTTSPause(); }

  // Toolbar modi
  function setToolbarMode(mode){
    const hideFlag = (mode !== 'task');
    flagBtn.classList.toggle('hidden', hideFlag);
    // Toolbar alleen zichtbaar bij opgaven
    toolbar.classList.toggle('show', mode === 'task');
  }

  function setNextEnabled(on){
    nextBtn.disabled = !on;
  }

  function normalizeClock(s){return s.toLowerCase().trim().replace('½','half').replace(/\s+/g,' ');}    

  function check(ix){
    const t=tasks[ix];
    if(!t||t.dataset.kind!=='task') return true;
    const ans=t.dataset.answer;
    const input=t.querySelector('input.input');
    const fb=t.querySelector('div.feedback');
    let ok=false, value=null;

    if(input){
      value=input.value.trim();
      ok=(ans==='half 4'? normalizeClock(value).includes('half 4') : String(ans)===value);
    }else{
      const r=t.querySelector('input[type=radio]:checked');
      value=r ? r.value : null;
      ok= value && value===ans;
    }

    // geen tekst terugkoppeling onder de vraag
    fb.textContent='';
    fb.className='feedback';

    if(value!==null && value!==""){
      state[ix].answered=true;
      state[ix].correct=ok;
      state[ix].value=value;
      if(ok && !t.dataset.counted){ score++; t.dataset.counted='1'; }
      if(!ok && t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
    }else{
      state[ix].answered=false;
      state[ix].correct=null;
      if(t.dataset.counted){ score=Math.max(0,score-1); delete t.dataset.counted; }
    }

    renderPager();
    return state[ix].answered ? ok : false;
  }

  function show(k){
    tasks.forEach((t,ix)=>t.classList.toggle('active', ix===k));
    progress.textContent = `${Math.min(k+1,tasks.length)} / ${tasks.length}`;
    const active = tasks[k];
    const kind = active?.dataset.kind;

    if(kind==='scene'){ document.body.classList.add('hide-ui'); }
    else { document.body.classList.remove('hide-ui'); }

    if(kind!=='scene'){
      sceneState.playing=false; sceneState.paused=false; sceneState.done=false; stopAllTTS();
      showPlayIcon();
      // Review altijd verbergen zodra je niet in het eindscherm bent
      const endSectionHide = tasks.find(t=>t.dataset.kind==='end');
      if(endSectionHide){ endSectionHide.classList.remove('show'); }
    }

    // stop geluidstest herhaling zodra je het intro verlaat
    if(kind!=='intro'){ stopSoundLoop(); }

    if(kind==='task'){
      setToolbarMode('task');
      const firstInput = active.querySelector('input,textarea,select');
      if(firstInput){ setTimeout(()=>firstInput.focus(), 50); }
      if(active.dataset.tts){ showTTSPlay(); } else { hideTTSControls(); }
      if(active.dataset.tts){ speakOnce(active.dataset.tts); }
      prevBtn.disabled = (itemIx.indexOf(k)===0);
      setNextEnabled(true);
      renderPager();

    }else if(kind==='intro'){
      setToolbarMode('intro');
      hideTTSControls();
      if(active.dataset.tts){ speakOnce(active.dataset.tts); }
      setNextEnabled(!!document.getElementById('soundOk')?.checked);
      renderPager(true);

    }else if(kind==='scene'){
      setToolbarMode('scene');
      hideTTSControls();
      setNextEnabled(false);
      // start de scène automatisch
      startSceneFromBeginning();
      renderPager(true);

    }else if(kind==='end'){
      setToolbarMode('end');
      fillReview();
      setNextEnabled(false);
      renderPager(true);
    }
  }

  // Paginering met altijd laatste nummer in beeld
  function renderPager(hideAll){
    pager.innerHTML='';
    if(hideAll){ return; }

    const total = itemIx.length;
    if(total===0) return;

    const currentIdx = itemIx.indexOf(i); // index binnen taken
    const shown = new Set();

    const makeBtn = (label, targetIx, current=false)=>{
      const b=document.createElement('button');
      b.className='pageBtn'+(current?' current':'');
      b.type='button';
      b.textContent=label;
      if(!current){
        b.addEventListener('click', ()=>{ i=itemIx[targetIx]; show(i); });
      }
      pager.appendChild(b);
      shown.add(targetIx);
    };
    const addEllipsis = ()=>{ const s=document.createElement('span'); s.className='ellipsis'; s.textContent='…'; pager.appendChild(s); };

    const first=0, last=total-1;

    makeBtn('1', first, currentIdx===first);

    if(currentIdx>3){ addEllipsis(); }

    const start=Math.max(1, currentIdx-2);
    const end=Math.min(last-1, currentIdx+4);
    for(let k=start; k<=end; k++){
      makeBtn(String(k+1), k, k===currentIdx);
    }

    if(currentIdx<last-4){ addEllipsis(); }

    if(!shown.has(last)){
      makeBtn(String(last+1), last, currentIdx===last);
    }
  }

  // Eindoverzicht
  function fillReview(){
    const totalEl=document.getElementById('total');
    const scoreEl=document.getElementById('score');
    const grid=document.getElementById('reviewGrid');
    const endSection = tasks.find(t=>t.dataset.kind==='end');
    if(endSection){ endSection.classList.add('show'); }
    const total = itemIx.length;
    totalEl.textContent = total;
    scoreEl.textContent = score;

    grid.innerHTML='';
    itemIx.forEach((ix,idx)=>{
      const t = state[ix];
      const tile = document.createElement('button');
      tile.className='tile';
      tile.type='button';
      tile.innerHTML = `<div class="nr">${idx+1}</div>`;
      const pill = document.createElement('div');
      pill.className='pill ' + (t.answered ? (t.correct ? 'ok' : 'wrong') : 'open');
      pill.textContent = t.answered ? (t.correct ? 'goed' : 'onjuist') : 'open';
      tile.appendChild(pill);
      if(t.flagged){ const f=document.createElement('div'); f.style.marginTop='6px'; f.textContent='⚑ gemarkeerd'; tile.appendChild(f); }
      tile.addEventListener('click', ()=>{ i=ix; show(i); });
      grid.appendChild(tile);
    });

    document.getElementById('toFirstOpen').onclick = ()=>{
      const openIx = itemIx.find(ix=> !state[ix].answered );
      if(openIx!==undefined){ i=openIx; show(i); }
    };
  }

  // Onderbalk knoppen
  prevBtn.addEventListener('click', ()=>{
    const kind = tasks[i]?.dataset.kind;

    if(kind==='scene'){ i = introIx>=0 ? introIx : i; show(i); return; }
    if(kind==='intro'){ return; }

    const idx=itemIx.indexOf(i);
    const prev = itemIx[idx-1];
    if(prev!==undefined){ i=prev; show(i); }
  });

  nextBtn.addEventListener('click', ()=>{
    const kind = tasks[i].dataset.kind;

    if(kind==='intro'){
      if(!document.getElementById('soundOk').checked) return;
      i = sceneIx>=0 ? sceneIx : i;
      show(i);
      return;
    }

    if(kind==='scene'){
      if(!sceneState.done){ return; } // blijft grijs tot klaar
      i = firstTask>=0 ? firstTask : i;
      show(i);
      return;
    }

    if(kind==='task'){
      check(i);
      const idx=itemIx.indexOf(i);
      const next = itemIx[idx+1];
      if(next!==undefined){ i=next; show(i); }
      else {
        i = tasks.findIndex(t=>t.dataset.kind==='end');
        if(i<0) i=tasks.length-1;
        show(i);
      }
      return;
    }
  });

  flagBtn.addEventListener('click', ()=>{
    if(tasks[i].dataset.kind!=='task') return;
    state[i].flagged = !state[i].flagged;
    flagBtn.classList.toggle('active', state[i].flagged);
    flagBtn.setAttribute('aria-pressed', state[i].flagged ? 'true' : 'false');
    renderPager();
  });

  // keyboard
  window.addEventListener('keydown', (e)=>{
    const kind = tasks[i]?.dataset.kind;
    if(kind==='task'){
      if(e.key==='ArrowRight'){ e.preventDefault(); nextBtn.click(); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); prevBtn.click(); }
      if(e.key.toLowerCase()==='m'){ e.preventDefault(); flagBtn.click(); }
    }
    if(kind==='intro' && e.key==='Enter'){ e.preventDefault(); nextBtn.click(); }
  });

  // inputs, direct check zonder tekstfeedback
  itemIx.forEach(ix=>{
    const node = tasks[ix];
    node.addEventListener('input', ()=>{ check(ix); });
    node.addEventListener('change', ()=>{ check(ix); });
  });

  // geluidstest, met herhaling
  const soundOk=document.getElementById('soundOk');
  const audioBtn=document.getElementById('audioPlay');
  const AudioCtx=window.AudioContext||window.webkitAudioContext; let ctx=null;
  function ensureCtx(){ if(!ctx&&AudioCtx){ ctx=new AudioCtx(); } }

  // patroon en helpers
  const DRUM_PATTERN=[
    {offset:0.0,freq:120,type:'sine'},
    {offset:0.4,freq:300,type:'square'},
    {offset:0.6,freq:800,type:'triangle'},
    {offset:0.8,freq:120,type:'sine'}
  ];

  function playDrum(time,freq=150,dur=0.2,type='sine'){
    const o=ctx.createOscillator(); const g=ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type=type; o.frequency.setValueAtTime(freq,time);
    g.gain.setValueAtTime(1,time); g.gain.exponentialRampToValueAtTime(0.001,time+dur);
    o.start(time); o.stop(time+dur);
  }

  function playDrumPatternAt(now){
    DRUM_PATTERN.forEach(p=> playDrum(now+p.offset,p.freq,0.15,p.type));
  }

  let soundLoopTimeouts=[];
  function stopSoundLoop(){
    soundLoopTimeouts.forEach(id=> clearTimeout(id));
    soundLoopTimeouts=[];
  }

  function playDrumPatternRepeated(times=3, gapMs=900){
    ensureCtx(); if(!ctx) return;
    stopSoundLoop();
    const firstStart = ctx.currentTime + 0.01;
    for(let r=0;r<times;r++){
      const tId = setTimeout(()=>{
        const now = ctx.currentTime;
        playDrumPatternAt(now);
      }, r*gapMs);
      soundLoopTimeouts.push(tId);
    }
  }

  function updateIntro(){
    if(tasks[i]?.dataset.kind==='intro'){
      setNextEnabled(!!soundOk.checked);
      if(soundOk.checked){ stopSoundLoop(); }
    }
  }

  soundOk.addEventListener('change', updateIntro);
  if(audioBtn){ audioBtn.addEventListener('click', ()=> playDrumPatternRepeated(4, 1000)); }

  // start
  function init(){
    i = 0;
    setToolbarMode('intro');
    show(i);
  }
  init();

})();
</script>
</body>
</html>
